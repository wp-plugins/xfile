//>>built
define("davinci/Workbench","dojo/_base/lang require ./Runtime ./model/Path ./workbench/ViewPart ./workbench/EditorContainer ./ui/Dialog dijit/Toolbar dijit/ToolbarSeparator dijit/Menu dijit/MenuBar dijit/MenuItem dijit/MenuSeparator dijit/PopupMenuBarItem dijit/form/Button dijit/form/DropDownButton dijit/form/ComboButton dijit/form/ToggleButton dijit/layout/BorderContainer dijit/layout/StackController dijit/layout/StackContainer dijit/layout/ContentPane dijit/layout/TabController dijit/layout/TabContainer system/resource dojo/i18n!./nls/webContent ./ve/metadata dojo/Deferred dojo/promise/all dojo/_base/declare dojo/_base/connect dojo/_base/xhr ./review/model/resource/root dojo/i18n!./ve/nls/common ./ve/utils/GeomUtils dojo/i18n!./ui/nls/common davinci/review/model/resource/root xide/manager/ServerActionBase".split(" "),
function(R,C,k,x,S,T,D,U,V,G,W,H,X,Y,Z,L,$,aa,y,na,I,E,oa,J,ba,u,M,F,ca,da,N,ea,fa,O,ga,P,ha,ia){var t={};Function.prototype.bind=Function.prototype.bind||function(a){return dojo.hitch(a,this)};var z=function(a){return"editor-"+encodeURIComponent(a.replace(/[\/| |\t]/g,"_")).replace(/%/g,":")},w=function(a){return a.replace(/^editor/,"shadow")},K=function(a){return a.replace(/^shadow/,"editor")},ka=function(a,b){if(401==b.status||403==b.status)ja();else if(!0===a.canceled){var c=a.ioArgs.url;RegExp("(^|\\.\\/|"+
document.baseURI+"\\/)cmd\\/").test(c)&&(0<=c.indexOf("getBluePageInfo")||k.handleError(b.message))}},ja=function(){var a=new D({title:u.sessionTimedOut}),b=dojo.string.substitute(u.sessionTimedOutMsg,{hrefLoc:"welcome"});a.set("content",b);dojo.connect(a,"onCancel",null,function(){window.location.href="welcome"});setTimeout(function(){window.location.href="welcome"},1E4);a.show()},la=function(){davinci.Workbench._expandCollapsePaletteContainers(null,{dontPreserveWidth:!0});var a=function(a){dojo.publish("/davinci/ui/initialPerspectiveReady",
[]);a.project&&d.setActiveProject(a.project);if(a.editors){a.version=davinci.version;var b,c=d.singleProjectMode();c&&(b=new x(d.getProject()));a.editors.forEach(function(g){var l=-1<g.indexOf(".review");if(l||!c||(new x(g)).startsWith(b)){var m=function(l){var m=!0;c&&((new x(a.activeEditor)).startsWith(b)||(m=!1));var s=g!=a.activeEditor;s&&(!m&&!(-1<a.activeEditor.indexOf(".review")))&&(s=!1,a.activeEditor=g);l&&d.openEditor({fileName:l,noSelect:s,isDirty:l.isDirty(),startup:!1,initializationTime:!0})};
if(l){var l=(new x(g)).segment(2),k=(new x(g)).removeFirstSegments(3).toString();fa.findFile(l,k).then(function(a){m(a)})}else m(ba.findResource(g))}})}else a.editors=[]};d._state||(d._state=k.getWorkbenchState());var b=dojo.cookie("davinci_designer"),c=dojo.cookie("davinci_version");dojo.cookie("davinci_designer",null,{expires:-1,path:"/"});dojo.cookie("davinci_version",null,{expires:-1,path:"/"});c&&b?ha.findVersion(b,c).then(function(b){b&&b.getChildren(function(b){b.forEach(function(a,b){var c=
a.getPath();0==b&&(d._state.activeEditor=c);0>d._state.editors.indexOf(c)&&d._state.editors.push(c)}.bind(this));a(d._state)})}.bind(this)):a(d._state);d.setupGlobalKeyboardHandler()},d={activePerspective:"",actionScope:[],_DEFAULT_PROJECT:"project1",hideEditorTabs:!0,_editorTabClosing:{},_shadowTabClosing:{},service:null,serviceClass:"XApp_XIDE_Workbench_Service",currentEditor:null,initService:function(){console.error("init workbench service");this.service||(this.service=new ia({serviceClass:"XApp_XIDE_Workbench_Service",
serviceUrl:"./xcf/xui.php?debug\x3dtrue\x26view\x3drpc",singleton:!1}),this.service.init())},getDefaultMount:function(){},run2:function(){k.subscribe("/davinci/ui/widgetPropertiesChanges",function(){var a=k.currentEditor.visualEditor;a._objectPropertiesChange.apply(a,arguments)})},run:function(){k.run();d._initKeys();d._baseTitle=dojo.doc.title;try{d.initService()}catch(a){debugger}window.maqetta&&(maqetta.TopBanner&&maqetta.TopBanner.setup)&&maqetta.TopBanner.setup();k.subscribe("/davinci/resource/resourceChanged",
function(a,b){if("deleted"==a){var e=z(b.getPath()),d=w(e),e=dijit.byId(e),d=dijit.byId(d);if(e&&!e._isClosing){var g=dijit.byId("editors_container"),l=dijit.byId("davinci_file_tabs");g.removeChild(e);e.destroyRecursive();l.removeChild(d);d.destroyRecursive()}}});k.subscribe("/dojo/io/error",ka);k.subscribe("/davinci/states/state/changed",function(a){var b=k.currentEditor;"davinci.ve.themeEditor.ThemeEditor"!=b.declaredClass&&"davinci.review.editor.ReviewEditor"!=b.declaredClass&&b.visualEditor.onContentChange.apply(b.visualEditor,
arguments)});k.subscribe("/davinci/ui/widgetPropertiesChanges",function(){var a=k.currentEditor.visualEditor;a._objectPropertiesChange.apply(a,arguments)});N.subscribe("/davinci/states/state/changed",function(a){var b=k.currentEditor&&"davinci.ve.PageEditor"==k.currentEditor.declaredClass&&k.currentEditor.visualEditor&&k.currentEditor.visualEditor.context;if(b){var e,d,b=b?b.getDijit():null,g=C("davinci/ve/widget");a.newState&&!a.newState.indexOf("_show:")&&(e=b.byId(a.newState.substring(6)),e=g.getWidget(e.domNode),
(d=e.getHelper())&&d.popup&&d.popup(e));a.oldState&&!a.oldState.indexOf("_show:")&&(e=b.byId(a.oldState.substring(6)),e=g.getWidget(e.domNode),(d=e.getHelper())&&d.tearDown&&d.tearDown(e))}});N.subscribe("/davinci/ui/repositionFocusContainer",function(a){d._repositionFocusContainer()});var b=this.service.serviceObject[this.serviceClass].getInfo().then(function(a){k._initializationInfo=a;a=a.userInfo;k.isLocalInstall="maqettaUser"==a.userId;k.userName=a.userId;k.userEmail=a.email;return M.init()}).then(function(){var a=
k.initialPerspective||"davinci.ui.main";dojo.query(".loading").orphan();d.showPerspective(a);d._updateTitle();la()}).otherwise(function(a){dojo.query("#load_screen").addContent(dojo.string.substitute(u.startupError,[a.message]),"only")});d._lastAutoSave=Date.now();setInterval(dojo.hitch(this,"_autoSave"),3E4);return b},_createEditor:function(a,b,c,n){var e=new F,f=b.split("/").pop(),g=c&&c.fileName&&c.fileName.extension?"."+c.fileName.extension:"",f=f+(".rev"==g?g:"");dojo.query(".loading").orphan();
var g=dijit.byId("editorsStackContainer"),l=dijit.byId("editors_container");g&&l&&(g.selectChild(l),d.mainStackContainer.selectChild(d.mainBorderContainer));var m=dijit.byId(z(b)),g=dijit.byId("editors_container"),l=dijit.byId("davinci_file_tabs"),k=!1,h=null;if(!m){var k=!0,h=z(b),p=w(h),m=new T({title:f,id:h,"class":"EditorContainer",isDirty:c.isDirty}),h=new E({title:f,closable:!0,id:p});h.onClose=function(a,b){function c(){n._skipDirtyCheck=!0;n.onClose.apply(n,[f,n]);a.removeChild(b);b.destroyRecursive()}
function e(){n.editor.save();c()}var g=K(b.id),n=dijit.byId(g),f=dijit.byId("editors_container");f&&n&&(n.editor.isDirty?((g=n.editor.getOnUnloadWarningMessage())||(g=dojo.string.substitute(u.fileHasUnsavedChanges,[n._getTitle()])),d.showDialog({title:n._getTitle(),content:g,style:{width:300},okLabel:P.save,okCallback:dojo.hitch(this,e),hideLabel:null,submitOnEnter:!0,extendLabels:[P.discard],extendCallbacks:[dojo.hitch(this,c)]})):c())}}a||(a={editorClass:"davinci/ui/TextEditor",id:"davinci.ui.TextEditor"});
k&&(g.addChild(m),l.addChild(h));if(!d.hideEditorTabs){var s=dojo.query(".dijitTabButtonIcon",m.controlButton.domNode);dojo.addClass(s[0],"tabButtonLoadingIcon");dojo.removeClass(s[0],"dijitNoIcon")}c.noSelect||g.selectChild(m);c.initializationTime||(d._state.activeEditor=b);m.setEditor(a,b,!0,c.fileName,m.domNode,n,c.item).then(function(a){c.startLine&&m.editor.select(c);c.noSelect||(-1===d._state.editors.indexOf(b)&&d._state.editors.push(b),d._switchEditor(m.editor,c.startup));d.hideEditorTabs||
(dojo.removeClass(s[0],"tabButtonLoadingIcon"),dojo.addClass(s[0],"dijitNoIcon"));setTimeout(function(){m.resize()},100);e.resolve(m.editor)},function(a){d.hideEditorTabs||(dojo.removeClass(s[0],"tabButtonLoadingIcon"),dojo.addClass(s[0],"tabButtonErrorIcon"));e.reject(a)});return e},getOpenEditor:function(a){return this.currentEditor?this.currentEditor:null!=a?(a=dijit.byId(z(a.getPath())))?a.editor:null:(a=dijit.byId("editors_container"))&&a.selectedChildWidget&&a.selectedChildWidget.editor?a.selectedChildWidget.editor:
null},closeActiveEditor:function(){var a=dijit.byId("editors_container"),b=dijit.byId("davinci_file_tabs");if(a&&a.selectedChildWidget&&a.selectedChildWidget.editor){var c=w(selectedChildWidget.id);a.closeChild(a.selectedChildWidget);(a=dijit.byId(c))&&b.closeChild(a)}},closeAllEditors:function(){var a=dijit.byId("editors_container");a&&a.getChildren().forEach(function(b){a.closeChild(b)})},getAllOpenEditorIds:function(){},unload:function(){d._autoSave()},logoff:function(a){dojo.create("div",{"class":"loading",
innerHTML:"\x3ctable\x3e\x3ctr\x3e\x3ctd\x3e\x3cspan\x3e\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;\x3c/span\x3e\x26nbsp;Logging off...\x3c/td\x3e\x3c/tr\x3e\x3c/table\x3e"},dojo.body(),"first");d.unload();return ea.get({url:"cmd/logoff",handleAs:"text"}).then(function(a){location.href="welcome"})},_createToolBar:function(a,b,c,n){var e=[];c||(c=k.getExtensions("davinci.actionSets"));for(var f=0,g=c.length;f<g;f++)for(var l=c[f].actions,m=0,q=l.length;m<q;m++){var h=l[m],p=h[a];p&&(e[p]||(e[p]=
[]),e[p].push(h))}var s=new U({"class":"davinciToolbar"},b);a={};b=!0;for(var Q in e)if(dojo.isArray(e[Q])){b?b=!1:(l=new V,s.addChild(l));l=e[Q];for(c=0;c<l.length;c++){h=l[c];if(null==h)debugger;d._loadActionClass(h);var v={showLabel:!1};["label","showLabel","iconClass"].forEach(function(a){h.hasOwnProperty(a)&&(v[a]=h[a])});h.className&&(v["class"]=h.className);var r,A=new F;if(h.menu&&("DropDownButton"==h.type||"ComboButton"==h.type)){f=new G({style:"display: none;"});for(g=0;g<h.menu.length;g++){var B=
h.menu[g];d._loadActionClass(B);var t={onClick:dojo.hitch(this,"_runAction",B,n)};["label","iconClass"].forEach(function(a){B[a]&&(t[a]=B[a])});m=new H(t);m._maqAction=B;f.addChild(m)}v.dropDown=f;r="DropDownButton"==h.type?new L(v):new $(v);r.onClick=dojo.hitch(this,"_runAction",h,n);r._maqAction=h;A.resolve()}else h.toggle||h.radioGroup?(r=new aa(v),r.item=h,r.set("checked",h.initialValue),h.radioGroup?((f=a[h.radioGroup])||(f=a[h.radioGroup]=[]),f.push(r),r.onChange=dojo.hitch(this,"_toggleButton",
r,n,f)):r.onChange=dojo.hitch(this,"_runAction",h,n),r._maqAction=h,A.resolve()):h.type?C([h.type],function(a){r=new a;r._maqActiond=h;A.resolve()}):(r=new Z(v),r.onClick=dojo.hitch(this,"_runAction",h,n),r._maqAction=h,A.resolve());h.icon&&(f=document.createElement("img"),f.src=h.icon,f.height=f.width=18,r.domNode.appendChild(f));A.then(function(){s.addChild(r);h.isEnabled&&!h.isEnabled()?(r.isEnabled=h.isEnabled,r.set("disabled",!0)):r.set("disabled",!1)})}}return s},showPerspective:function(a){d.activePerspective=
a;var b=d._createMenuTree();d._updateMainMenubar(dojo.byId("davinci_main_menu"),b);b=this.getActionSets("davinci.ui.editorMenuBar").clonedActionSets;b.length&&(b=d._createMenuTree(b),d._updateMainMenubar(dojo.byId("maq_banner_editor_commands"),b));b=dojo.byId("mainBody");b.tabs||(b.tabs=[]);var c=dijit.byId("mainBody");c||(c=new y({gutters:!1,region:"center",design:"sidebar"},b));var n=k.getExtension("davinci.perspective",a);n||k.handleError(dojo.string.substitute(u.perspectiveNotFound,[a]));var n=
dojo.clone(n),e=k.getExtensions("davinci.perspectiveExtension",function(b){return b.targetID===a});dojo.forEach(e,function(a){dojo.forEach(a.views,function(a){n.views.push(a)})});b.editorsStackContainer||(d.editorsStackContainer=b.editorsStackContainer=new I({region:"center",id:"editorsStackContainer",controllerWidget:"dijit.layout.StackController"}));c.addChild(b.editorsStackContainer);b.editorsWelcomePage||(d.editorsWelcomePage=b.editorsWelcomePage=new E({id:"editorsWelcomePage",href:"app/davinci/ve/resources/welcome_to_maqetta.html"}));
b.editorsStackContainer.addChild(b.editorsWelcomePage);b.tabs.editors||(d.editorTabs=b.tabs.editors=new (d.hideEditorTabs?I:J)({id:"editors_container",controllerWidget:d.hideEditorTabs?"dijit.layout.StackController":"dijit.layout.TabController"}),d.editorTabs.setTitle=function(a,b){a.attr("title",b);a.domNode.title="";if(d.hideEditorTabs){var c=w(a.id);dijit.byId("davinci_file_tabs").tablist.pane2button[c].attr("label",b+(a.isDirty?'\x3cspan class\x3d"dirtyFileAsterisk"\x3e\x3c/span\x3e':""))}else this.tablist.pane2button[a.id].attr("label",
b)},dojo.connect(b.tabs.editors,"removeChild",this,d._editorTabClosed));b.editorsStackContainer.addChild(b.tabs.editors);b.editorsStackContainer.selectChild(b.editorsWelcomePage);dojo.connect(dijit.byId("editors_container"),"selectChild",function(a){if(!d._processingSelectChild){d._processingSelectChild=!0;var b=w(a.id),b=dijit.byId(b),c=dijit.byId("davinci_file_tabs");b&&c&&c.selectChild(b);a.editor&&d._switchEditor(a.editor);d._processingSelectChild=!1}});c.startup();var f=dijit.byId("davinci_app");
if(!f){var f=new y({design:"headline",gutters:!1,liveSplitters:!1},"davinci_app"),e=new E({region:"top",layoutPriority:1},"davinci_top_bar"),g=d.mainStackContainer=b.editorsStackContainer=new I({region:"center",id:"mainStackContainer",controllerWidget:"dijit.layout.StackController"}),l=d.mainBorderContainer=new y({design:"headline",gutters:!1,id:"mainBorderContainer",liveSplitters:!1}),m=d.shadowTabs=new J({id:"davinci_file_tabs",closable:!0,region:"top",layoutPriority:1,style:"display:none"});d.shadowTabs.setTitle=
function(a,b){a.attr("title",b);this.tablist.pane2button[a.id].attr("label",b)};dojo.connect(m,"selectChild",function(a){a=K(a.id);a=dijit.byId(a);var b=dijit.byId("editors_container");b&&(a&&a.editor)&&b.selectChild(a)});dojo.connect(m,"removeChild",this,d._shadowTabClosed);var q=new E({id:"davinci_toolbar_pane",region:"top",layoutPriority:1,content:'\x3cdiv id\x3d"davinci_toolbar_container"\x3e\x3c/div\x3e',style:"display:none"});f.addChild(e);f.addChild(g);g.addChild(l);g.selectChild(l);l.addChild(m);
l.addChild(q);l.addChild(c);f.layout();f.startup();d._originalOnResize=window.onresize;window.onresize=d.onResize;dojo.connect(c,"onMouseUp",this,"onResize");(c=dijit.byId("davinci_file_tabs_tablist_Menu"))&&c.addChild(new dijit.MenuItem({label:O.closeAllEditors,onClick:this.closeAllEditors}))}for(var h in b.tabs.perspective){var p=b.tabs.perspective[h];p&&(dojo.forEach(p.getChildren(),function(a){p.removeChild(a);"left"!=h&&"right"!=h&&a.destroyRecursive(!1)}),p.destroyRecursive(!1),delete b.tabs.perspective[h])}this._showViewPromises=
dojo.map(n.views,function(a){return d.showView(a.viewID,a.selected,a.hidden)},this);davinci.Workbench.focusContainer=dojo.create("div",{"class":"focusContainer",id:"focusContainer"},document.body);setTimeout(function(){f.resize();dojo.publish("/davinci/workbench/ready",[])}.bind(this),3E3)},onResize:function(a){var b=a.explicitOriginalTarget?a.explicitOriginalTarget:a.srcElement;if("resize"==a.type||b.id&&-1<b.id.indexOf("dijit_layout__Splitter_")||b.nextSibling&&b.nextSibling.id&&-1<b.nextSibling.id.indexOf("dijit_layout__Splitter_"))if((a=
davinci&&k.currentEditor)&&a.onResize)a.onResize();d._originalOnResize&&d._originalOnResize();d._repositionFocusContainer()},updateMenubar:function(a,b){var c=d._createMenuTree(b),n=dijit.byId(a.id);n||(n=new W({"class":"dijitInline"},a));d._addItemsToMenubar(c,n)},_updateMainMenubar:function(a,b){for(var c=0;c<b.length;c++)for(var n=b[c],e=0;e<n.menus.length;e++){var f=n.menus[e],g=d._createMenu(f);f.id=f.id.replace(".","-");if(window.maqetta&&maqetta.TopBanner&&maqetta.TopBanner.attachMenu)maqetta.TopBanner.attachMenu(f,
g,a);else{var l=dijit.byId(f.id+"-dropdown");l||(g={label:f.label,dropDown:g,id:f.id+"-dropdown"},f.hasOwnProperty("showLabel")&&(g.showLabel=f.showLabel),f.hasOwnProperty("iconClass")&&(g.iconClass=f.iconClass),f.hasOwnProperty("className")&&(g["class"]=f.className),l=new L(g),a.appendChild(l.domNode))}}},_addItemsToMenubar:function(a,b){dojo.forEach(a,function(a){a=a.menus;a.length&&dojo.forEach(a,function(a){a.id=a.id.replace(/\./g,"-");var c=d._createMenu(a),f=dijit.byId(a.id+"-dropdown");f||
(f=new Y({label:a.label,popup:c,id:a.id+"-dropdown"}));b.addChild(f)},this)},this)},showModal:function(a,b,c,d,e,f){return D.showModal(a,b,c,d,e,f)},showMessage:function(a,b,c,d,e){return D.showMessage(a,b,c,d,e)},showDialog:function(a){return D.showDialog(a)},_createMenuTree:function(a,b){function c(a,b,c){b=(b||"additions").split("/");var e=n;d._loadActionClass(a);var g=b[b.length-1];if(1<b.length)for(var f=0,l=b.length-1;f<l;f++){var m;a:{m=0;for(var h=e.length;m<h;m++)for(var k=0,p=e[m].menus.length;k<
p;k++)if(b[f]==e[m].menus[k].id){m=e[m].menus[k].menus;break a}m=void 0}m&&(e=m)}f=0;for(l=e.length;f<l;f++)if(e[f].id==g){b=e[f].menus;b.push(a);if(a.separator){c=!1;b=a.menus=[];for(e=0;e<a.separator.length;e+=2)g=a.separator[e],c="additions"==g,b.push({id:g,isSeparator:a.separator[e+1],menus:[]});c||b.push({id:"additions",isSeparator:!1,menus:[]})}return}c&&n.push({id:g,isSeparator:!1,menus:[a]})}a||(a=k.getExtensions("davinci.actionSets",function(a){return 0==k.getExtensions("davinci.actionSetPartAssociations",
function(b){return b.targetID==a.id}).length}));for(var n=[],e=0,f=a.length;e<f;e++){var g=a[e];if(g.visible&&g.menu)for(var l=0,m=g.menu.length;l<m;l++){var q=g.menu[l];if(q.__mainMenu)for(var h=0;h<q.separator.length;h+=2)n.push({id:q.separator[h],isSeparator:q.separator[h+1],menus:[]});else if(c(q,q.path,b),q.populate instanceof Function){var q=q.populate(),p;for(p in q)c(q[p],q[p].menubarPath)}}}e=0;for(f=a.length;e<f;e++)if(g=a[e],g.visible){l=0;for(m=g.actions.length;l<m;l++)p=g.actions[l],
p.menubarPath&&c(p,p.menubarPath,b)}return n},_loadActionClass:function(a){a&&"string"==typeof a.action&&C([a.action],function(b){try{if(b)a.action=new b,a.action.item=a;else debugger}catch(c){console.error("action class creation failed : "+a.action)}})},_createMenu:function(a,b){var c,d,e;a.menus?(c=new G({parentMenu:a}),d=a.menus,e="onOpen"):(c=new ma({}),d=a,e="menuOpened");c.domNode.style.display="none";c.actionContext=b;this._rebuildMenu(c,d);dojo.connect(c,e,this,function(a){c._widgetCallback&&
c._widgetCallback(a);this._rebuildMenu(c,d).focus()});return c},singleProjectMode:function(){return!0},getProject:function(){return d.getActiveProject()||d._DEFAULT_PROJECT},loadProject:function(a){d.setActiveProject(a);return d.updateWorkbenchState().then(function(){location.href="cmd/configProject?configOnly\x3dtrue\x26project\x3d"+encodeURIComponent(a)})},location:function(){return k.location()},_rebuildMenu:function(a,b){dojo.forEach(a.getChildren(),function(b){a.removeChild(b);b.destroy()});
a.focusedChild=null;var c,n;b.forEach(function(b,f){b.menus.length&&(b.isSeparator&&0<f&&(c=!0),b.menus.forEach(function(b){c&&n&&(a.addChild(new X({})),c=!1);n=!0;var e=b.label;b.action&&b.action.getName&&(e=b.action.getName());if(b.separator)b=d._createMenu(b),b=new H({label:e,popup:b,id:b.id+"item"}),b.actionContext=a.actionContext,a.addChild(b);else{var f=!0;b.isEnabled&&(f=k.getSelection(),f=(f=f[0]&&f[0].resource)?b.isEnabled(f):!1);if(b.action){if(b.action.shouldShow&&!b.action.shouldShow(a.actionContext,
{menu:a})){"Select parent"===e&&b.action.shouldShow(a.actionContext,{menu:a});return}f=b.action.isEnabled&&b.action.isEnabled(a.actionContext)}e={label:e,id:b.id,disabled:!f,onClick:dojo.hitch(this,"_runAction",b,a.actionContext)};b.iconClass&&(e.iconClass=b.iconClass);a.addChild(new H(e))}},this))},this);return a},_toggleButton:function(a,b,c,n){a.checked&&(c.forEach(function(b){b!=a&&b.set("checked",!1)}),d._runAction(a.item,b,a.item.id))},_runAction:function(a,b,c){b&&k.currentEditor&&(b=k.currentEditor);
if(a.run)a.run();else if(a.action)dojo.isString(a.action)&&this._loadActionClass(a),a.action.run(b);else if(a.method&&b&&b[a.method]instanceof Function)b[a.method](c);else a.commandID&&k.executeCommand(a.commandID)},showView:function(a,b,c){var n=new F;try{var e=dijit.byId("mainBody"),f=k.getExtension("davinci.view",a),g=dojo.byId("mainBody"),l=k.getExtension("davinci.perspective",d.activePerspective),m="left",q;dojo.some(l.views,function(b){if(b.viewID==a)return m=b.position,!0});g.tabs=g.tabs||
{};g.tabs.perspective=g.tabs.perspective||{};"right"==m&&!g.tabs.perspective.right&&(e.addChild(g.tabs.perspective.right=new y({"class":"davinciPaletteContainer",style:"width: 71px;",id:"right_mainBody",minSize:71,region:"right",gutters:!1,splitter:!0})),g.tabs.perspective.right.startup(),t.right_mainBody={expandToSize:340,initialExpandToSize:340});"left"==m&&!g.tabs.perspective.left&&(e.addChild(g.tabs.perspective.left=new y({"class":"davinciPaletteContainer",style:"width: 71px;",id:"left_mainBody",
minSize:71,region:"left",gutters:!1,splitter:!0})),g.tabs.perspective.left.startup(),t.left_mainBody={expandToSize:318,initialExpandToSize:318});if("left"===m||"right"===m)m+="-top";l=m;if(g.tabs.perspective[m])q=g.tabs.perspective[m];else{var l=m.split("-"),h=l[0],p="davinciPalette ",s="";l[1]&&("left"==h||"right"==h)?(e=g.tabs.perspective[h],h=l[1],"top"==l[1]?(h="center",p+="davinciTopPalette"):(s="height:30%;",p+="davinciBottomPalette")):"bottom"==h&&(s="height:80px;",p+="davinciBottomPalette");
q=g.tabs.perspective[m]=new J({region:h,id:"palette-tabcontainer-"+m,tabPosition:l[0]+"-h",tabStrip:!1,"class":p,style:s,splitter:"center"!=h,controllerWidget:"dijit.layout.TabController"});e.addChild(q);dojo.connect(q,"selectChild",this,function(a){if(a&&a.domNode){var b=a.getParent();!this._showViewAddChildInProcess&&!b._maqDontExpandCollapse&&(b._maqLastSelectedChild==a?this._expandCollapsePaletteContainer(a):this.expandPaletteContainer(a.domNode));b._maqLastSelectedChild=a}}.bind(this))}if(dojo.some(q.getChildren(),
function(a){return a.id==f.id}))return;this.instantiateView(f).then(function(a){this._showViewAddChildInProcess=!0;c||q.addChild(a);this._showViewAddChildInProcess=!1;var e=a.controlButton;e&&e.domNode&&(e.domNode.title=f.title+" "+O.palette);b&&q.selectChild(a);n.resolve(a)}.bind(this))}catch(u){console.error("Error loading view: "+f.id),console.error(u)}return n},instantiateView:function(a){var b=new F,c=dijit.byId(a.id);c?b.resolve(c):C([a.viewClass],function(c){var e={title:a.title,id:a.id,closable:!1,
view:a};a.iconClass&&(e.iconClass=a.iconClass);d.palettes||(d.palettes={});b.resolve((d.palettes[a.viewClass]=new (c||S)(e),d.palettes[a.viewClass]))});return b},hideView:function(a){for(var b in mainBody.tabs.perspective){if("left"==b||"right"==b)b+="-top";if(mainBody.tabs.perspective[b])for(var c=mainBody.tabs.perspective[b].getChildren(),d=0;d<c.length;d++)c[d].id==a&&(mainBody.tabs.perspective[b].removeChild(c[d]),c[d].destroyRecursive(!1))}},toggleView:function(a){dojo.byId(a)?d.hideView(a):
d.showView(a,!0)},openEditor:function(a,b){try{var c=a.fileName,n;"string"==typeof c?n=c.substr(c.lastIndexOf(".")+1):(n=c.getExtension(),c=c.getPath());var e=dijit.byId(z(c)),f=dijit.byId("editors_container");if(e){f.selectChild(e);var g=e.editor;a.startOffset&&g.select(a)}else{var l=a.editorCreateCallback,m=k.getExtensions("davinci.editor",function(a){"string"==typeof a.extensions&&(a.extensions=a.extensions.split(","));return dojo.some(a.extensions,function(a){return a.toLowerCase()==n.toLowerCase()})}),
q=m[0];1<m.length&&dojo.some(m,function(a){q=a;return a.isDefault});d._createEditor(q,c,a,b).then(function(b){l&&l.call(window,b);a.noSelect||(k.currentEditor=b)},function(a){console.error("Error opening editor for filename: "+c,a)})}}catch(h){console.error("Exception opening editor for filename: "+a&&a.fileName),console.error(h)}},createPopup:function(a){var b=a.partID,c=a.domNode,n=a.context,e=a.openCallback,f=this.getActionSets(b),g=f.clonedActionSets,f=f.actionSets;if(0<g.length)return g=d._createMenuTree(g,
!0),d._initActionsKeys(f,a),(a=d._createMenu(g,n))&&c&&a.bindDomNode(c),a._widgetCallback=e,a._partID=b,a},getActionSets:function(a){var b=[];k.getExtension("davinci.actionSetPartAssociations",function(c){return c.parts.some(function(d){if(d==a)return b.push(c.targetID),!0})});var c,d=[];b.length&&(c=k.getExtensions("davinci.actionSets",function(a){return b.some(function(b){return b==a.id})}),c.length&&c.forEach(function(a){var b=M.getLibraryActions(a.id);b.length&&(a=R.mixin({},a),a.actions=a.actions.concat(b));
d.push(a)}));return{actionSets:c,clonedActionSets:d}},_initActionsKeys:function(a,b){var c=b.keysDomNode||b.domNode,n={},e;dojo.forEach(a,function(a){dojo.forEach(a.actions,function(a){a.keySequence&&(n[a.keySequence]=a,e=!0)})});if(e){var f=b.context;dojo.connect(c,"onkeydown",function(a){a=d._keySequence(a);(a=n[a])&&(!a.action.shouldShow||a.action.shouldShow(f))&&a.action.isEnabled(f)&&d._runAction(a,f)})}},_initKeys:function(){var a={all:[]},b=k.getExtensions("davinci.keyBindings");dojo.forEach(b,
function(b){var d=b.contextID||"all",e=a[d];e||(e=a[d]=[]);e[b.sequence]=b.commandID});d.keyBindings=a},handleKey:function(a){if(d.keyBindings){a=d._keySequence(a);var b;d.currentContext&&d.keyBindings[d.currentContext]&&(b=d.keyBindings[d.currentContext][a]);b||(b=d.keyBindings.all[a]);if(b)return k.executeCommand(b),!0}},_keySequence:function(a){var b=[];window.event?(window.event.ctrlKey&&b.push("M1"),window.event.shiftKey&&b.push("M2"),window.event.altKey&&b.push("M3")):((a.ctrlKey||2==a.modifiers||
3==a.modifiers||5<a.modifiers)&&b.push("M1"),(a.shiftKey||3<a.modifiers)&&b.push("M2"),a.modifiers?(a.altKey||a.modifiers%2)&&b.push("M3"):a.altKey&&b.push("M3"));var c=String.fromCharCode(a.keyCode);/[A-Z0-9]/.test(c)||(c={46:"del",114:"f3"}[a.keyCode]||"xxxxxxxxxx");c=c.toUpperCase();" "==c&&(c="' '");b.push(c);return b.join("+")},setActionScope:function(a,b){d.actionScope[a]=b},findView:function(a){if(a=dijit.byId(a))return a},_switchEditor:function(a,b){var c=k.currentEditor;k.currentEditor=a;
d._state.activeEditor=a?a.fileName:null;this._removeFocusContainerChildren();this._showEditorTopPanes();try{dojo.publish("/davinci/ui/editorSelected",[{editor:a,oldEditor:c}])}catch(n){console.error(n)}d._updateTitle(a);setTimeout(function(){a&&(a.visualEditor&&a.visualEditor.context&&a.visualEditor.context.isActive())&&a.visualEditor.context.getTopWidgets().forEach(function(a){a.resize&&a.resize()});this._repositionFocusContainer()}.bind(this),1E3);ca(this._showViewPromises).then(function(){a&&a.focus&&
a.focus();this._rearrangePalettes(a);this._expandCollapsePaletteContainers(a)}.bind(this));b||(d.saveState=!0)},_rearrangePalettes:function(a){var b,c,d;if(a){if((c=k.getExtensions("davinci.editor",function(b){return a?b.id===a.editorID:!1}))&&0<c.length){var e=c[0];b=e.palettePerspective}c=a._rightPaletteExpanded;d=a._leftPaletteExpanded}else b=k.initialPerspective||"davinci.ui.main";b&&((b=k.getExtension("davinci.perspective",b))||k.handleError(dojo.string.substitute(u.perspectiveNotFound,[e.palettePerspective])),
dojo.forEach(b.views,function(a){var b=a.viewID,c=a.position;0>c.indexOf("bottom")&&(c+="-top");if(b=dijit.byId(b)){var d=b.getParent(),c=mainBody.tabs.perspective[c];d!=c&&(d&&d.removeChild(b),a.hidden||(c.addChild(b),d=c));d&&(a.hidden?d.removeChild(b):a.selected&&(d._maqDontExpandCollapse=!0,d.selectChild(b),delete d._maqDontExpandCollapse))}}));a&&(a.hasOwnProperty("_rightPaletteExpanded")&&(a._rightPaletteExpanded=c),a.hasOwnProperty("_leftPaletteExpanded")&&(a._leftPaletteExpanded=d))},_nearlyCollapsed:function(a){a=
dojo.style(a,"width");"string"==typeof a&&(a=parseInt(a));return 91>a},_expandCollapsePaletteContainer:function(a){if(a&&a.domNode&&(a=davinci.Workbench.findPaletteContainerNode(a.domNode),a.id)){var b=a._maqExpanded,c;this._nearlyCollapsed(a)&&(b=!1,c=91<=t[a.id].expandToSize?t[a.id].expandToSize:t[a.id].initialExpandToSize);b?this.collapsePaletteContainer(a):this.expandPaletteContainer(a,{expandToSize:c})}},_expandCollapsePaletteContainers:function(a,b){var c=dijit.byId("left_mainBody"),d=dijit.byId("right_mainBody");
if(a){var e=k.getExtensions("davinci.editor",function(b){return b.id===a.editorID});if(e&&0<e.length){var e=e[0].expandPalettes,f;c&&((f=a&&a.hasOwnProperty("_leftPaletteExpanded")?a._leftPaletteExpanded:e&&0<=e.indexOf("left"))?this.expandPaletteContainer(c.domNode,b):this.collapsePaletteContainer(c.domNode,b));d&&((f=a&&a.hasOwnProperty("_rightPaletteExpanded")?a._rightPaletteExpanded:e&&0<=e.indexOf("right"))?this.expandPaletteContainer(d.domNode,b):this.collapsePaletteContainer(d.domNode,b))}}else c&&
this.collapsePaletteContainer(c.domNode,b),d&&this.collapsePaletteContainer(d.domNode,b)},_updateTitle:function(a){var b=d._baseTitle;a&&(b+=" - ",a.isDirty&&(b+="*"),b+=a.fileName);dojo.doc.title=b},_editorTabClosed:function(a){if(!davinci.Workbench._editorTabClosing[a.id]){davinci.Workbench._editorTabClosing[a.id]=!0;if(a&&a.editor&&a.editor.fileName){var b=w(a.id),c=dijit.byId("davinci_file_tabs"),n=dijit.byId(b),e=d._state.editors.indexOf(a.editor.fileName);-1!=e&&d._state.editors.splice(e,1);
d.saveState=!0;davinci.Workbench._shadowTabClosing[b]||(c.removeChild(n),n.destroyRecursive())}dijit.byId("editors_container").getChildren().length||(d._switchEditor(null),this._expandCollapsePaletteContainers(null),b=dijit.byId("editorsStackContainer"),c=dijit.byId("editorsWelcomePage"),b&&c&&b.selectChild(c),this._hideEditorTopPanes());delete davinci.Workbench._editorTabClosing[a.id]}},_shadowTabClosed:function(a){if(!davinci.Workbench._shadowTabClosing[a.id]){davinci.Workbench._shadowTabClosing[a.id]=
!0;var b=K(a.id);if(!davinci.Workbench._editorTabClosing[b]){var b=dijit.byId(b),c=dijit.byId("editors_container");c&&b&&(c.removeChild(b),b.destroyRecursive())}delete davinci.Workbench._shadowTabClosing[a.id]}},getActiveProject:function(){return"project1"},setActiveProject:function(a){d._state||(d._state={});d._state.project=a;d.saveState=!0},workbenchStateCustomPropGet:function(a){if("string"==typeof a)return d._state[a]},workbenchStateCustomPropSet:function(a,b){"string"==typeof a&&("undefined"==
typeof b?delete d._state[a]:d._state[a]=b,d.saveState=!0)},clearWorkbenchState:function(){d._state={};return d.updateWorkbenchState()},updateWorkbenchState:function(){delete d.saveState;return null},_autoSave:function(){var a=d._lastAutoSave,b=!1;if(this.currentEditor){var c=this.currentEditor;if(c.isReadOnly||!c.isDirty)console.error("workbench : autosave failed : isReadyOnly or is not dirty");else{var n=c.lastModifiedTime;if(n&&n>a)try{c.save(!0)}catch(e){console.error("Error while autosaving file:"+
e),b=!0}}}b||(d._lastAutoSave=Date.now())},setupGlobalKeyboardHandler:function(){var a=k.getExtensions("davinci.actionSets");dojo.forEach(a,function(a){("davinci.ui.main"==a.id||"davinci.ui.editorActions"==a.id)&&dojo.forEach(a.actions,function(a){a.keyBinding&&k.registerKeyBinding(a.keyBinding,a)})})},findPaletteContainerNode:function(a){for(var b;a&&"BODY"!=a.tagName;){if(dojo.hasClass(a,"davinciPaletteContainer")){b=a;break}a=a.parentNode}return b},collapsePaletteContainer:function(a,b){var c=
davinci.Workbench.findPaletteContainerNode(a);if(c&&c.id){var d=c.id,e=dojo.style(c,"width"),f=dijit.byNode(c),g=dojo.query("[role\x3dtablist]",c);if(f&&0<g.length){var g=dojo.marginBox(g[0]),l=f.getParent();if(l&&l.resize&&g&&g.w){if(!this._nearlyCollapsed(c)&&(!b||!b.dontPreserveWidth))t[d].expandToSize=e;c.style.width=g.w+"px";l.resize();f._isCollapsed=!0}}dojo.removeClass(c,"maqPaletteExpanded");c._maqExpanded=!1;davinci.Workbench._repositionFocusContainer();if(d=k.currentEditor)"left_mainBody"==
c.id?d._leftPaletteExpanded=!1:"right_mainBody"==c.id&&(d._rightPaletteExpanded=!1)}},expandPaletteContainer:function(a,b){var c=b&&b.expandToSize,d=davinci.Workbench.findPaletteContainerNode(a);if(d&&d.id){var e=d.id,f=dijit.byNode(d);c&&(t[e].expandToSize=c);if(f&&t[e].expandToSize&&(c=f.getParent())&&c.resize)d.style.width=t[e].expandToSize+"px",c.resize(),delete f._isCollapsed;dojo.addClass(d,"maqPaletteExpanded");d._maqExpanded=!0;davinci.Workbench._repositionFocusContainer();if(e=k.currentEditor)"left_mainBody"==
d.id?e._leftPaletteExpanded=!0:"right_mainBody"==d.id&&(e._rightPaletteExpanded=!0)}},getFocusContainer:function(){var a=document.getElementById("focusContainer");a||(a=dojo.create("div",{"class":"focusContainer",id:"focusContainer"},document.body),davinci.Workbench.focusContainer=a);return a},_repositionFocusContainer:function(){var a=dojo.byId("editorsStackContainer"),b=this.getFocusContainer();if(a&&b){var c=k.currentEditor;if(a=c&&c.getFocusContainerBounds?c.getFocusContainerBounds():ga.getBorderBoxPageCoords(a))b.style.left=
a.l+"px",b.style.top=a.t+"px",b.style.width=a.w+"px",b.style.height=a.h+"px",c&&c.getContext&&(b=c.getContext())&&b.updateFocusAll&&b.updateFocusAll()}},_hideShowEditorTopPanes:function(a){},_hideEditorTopPanes:function(){this._hideShowEditorTopPanes("none")},_showEditorTopPanes:function(){this._hideShowEditorTopPanes("block")},_removeFocusContainerChildren:function(){davinci.Workbench.focusContainer&&(davinci.Workbench.focusContainer.innerHTML="")},_XX_last_member:!0},ma=da(G,{menuOpened:function(a){},
_openMyself:function(a){this.menuOpened(a);var b;try{var c=document.getElementById("menuOverlayDiv");c||(c=dojo.create("div",{id:"menuOverlayDiv",style:"left:0px; top:0px; width:100%; height:100%; position:absolute; z-index:10;"},document.body));if(this.adjustPosition){var d=this.adjustPosition(a);b=dijit.popup.open;dijit.popup.open=function(a){a.x+=d.x;a.y+=d.y;b.call(dijit.popup,a)}}this.onClose=function(){var a=document.getElementById("menuOverlayDiv");a&&a.parentNode.removeChild(a)}.bind(this);
this.inherited(arguments)}finally{b&&(dijit.popup.open=b)}}});window.setInterval(function(){d.saveState&&d.updateWorkbenchState()},5E3);dojo.setObject("davinci.Workbench",d);return d});
//# sourceMappingURL=Workbench.js.map