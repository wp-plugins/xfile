//>>built
/*

 Copyright (c) 2010, 2012 IBM Corporation and others.
 All rights reserved. This program and the accompanying materials are made 
 available under the terms of the Eclipse Public License v1.0 
 (http://www.eclipse.org/legal/epl-v10.html), and the Eclipse Distribution 
 License v1.0 (http://www.eclipse.org/org/documents/edl-v10.html). 

 Contributors: IBM Corporation - initial API and implementation
               Alex Lakatos - fix for bug#369781
*/
define("davinci/ui/TextStyler",["orion/editor/annotations"],function(r){function q(a,b){this.keywords=a;this.whitespacesVisible=b;this.setText("")}function w(){q.call(this,null,!0)}function t(a){q.call(this,null,a)}function x(){q.call(this,null,!1)}function A(a,b,d){this.commentStart="/*";this.commentEnd="*/";var f=[];switch(b){case "java":f=J;break;case "js":f=K;break;case "css":f=L}this.whitespacesVisible=!1;this.detectHyperlinks=!0;this.highlightCaretLine=!1;this.detectTasks=this.foldingEnabled=
!0;this._scanner=new q(f,this.whitespacesVisible);this._firstScanner=new x;this._commentScanner=new t(this.whitespacesVisible);this._whitespaceScanner=new w;"css"===b&&(this._scanner.isCSS=!0,this._firstScanner.isCSS=!0);this.view=a;this.annotationModel=d;this._bracketAnnotations=void 0;var c=this;this._listener={onChanged:function(a){c._onModelChanged(a)},onDestroy:function(a){c._onDestroy(a)},onLineStyle:function(a){c._onLineStyle(a)},onMouseDown:function(a){c._onMouseDown(a)},onSelection:function(a){c._onSelection(a)}};
b=a.getModel();b.getBaseModel&&(b=b.getBaseModel());b.addEventListener("Changed",this._listener.onChanged);a.addEventListener("MouseDown",this._listener.onMouseDown);a.addEventListener("Selection",this._listener.onSelection);a.addEventListener("Destroy",this._listener.onDestroy);a.addEventListener("LineStyle",this._listener.onLineStyle);this._computeComments();this._computeFolding();a.redrawLines()}var K="break case class catch continue const debugger default delete do else enum export extends false finally for function if implements import in instanceof interface let new null package private protected public return static super switch this throw true try typeof undefined var void while with yield".split(" "),
J="abstract boolean break byte case catch char class continue default do double else extends false final finally float for if implements import instanceof int interface long native new null package private protected public return short static super switch synchronized this throw throws transient true try void volatile while".split(" "),L="alignment-adjust alignment-baseline animation animation-delay animation-direction animation-duration animation-iteration-count animation-name animation-play-state animation-timing-function appearance azimuth backface-visibility background background-attachment background-clip background-color background-image background-origin background-position background-repeat background-size baseline-shift binding bleed bookmark-label bookmark-level bookmark-state bookmark-target border border-bottom border-bottom-color border-bottom-left-radius border-bottom-right-radius border-bottom-style border-bottom-width border-collapse border-color border-image border-image-outset border-image-repeat border-image-slice border-image-source border-image-width border-left border-left-color border-left-style border-left-width border-radius border-right border-right-color border-right-style border-right-width border-spacing border-style border-top border-top-color border-top-left-radius border-top-right-radius border-top-style border-top-width border-width bottom box-align box-decoration-break box-direction box-flex box-flex-group box-lines box-ordinal-group box-orient box-pack box-shadow box-sizing break-after break-before break-inside caption-side clear clip color color-profile column-count column-fill column-gap column-rule column-rule-color column-rule-style column-rule-width column-span column-width columns content counter-increment counter-reset crop cue cue-after cue-before cursor direction display dominant-baseline drop-initial-after-adjust drop-initial-after-align drop-initial-before-adjust drop-initial-before-align drop-initial-size drop-initial-value elevation empty-cells fit fit-position flex-align flex-flow flex-inline-pack flex-order flex-pack float float-offset font font-family font-size font-size-adjust font-stretch font-style font-variant font-weight grid-columns grid-rows hanging-punctuation height hyphenate-after hyphenate-before hyphenate-character hyphenate-lines hyphenate-resource hyphens icon image-orientation image-rendering image-resolution inline-box-align left letter-spacing line-height line-stacking line-stacking-ruby line-stacking-shift line-stacking-strategy list-style list-style-image list-style-position list-style-type margin margin-bottom margin-left margin-right margin-top mark mark-after mark-before marker-offset marks marquee-direction marquee-loop marquee-play-count marquee-speed marquee-style max-height max-width min-height min-width move-to nav-down nav-index nav-left nav-right nav-up opacity orphans outline outline-color outline-offset outline-style outline-width overflow overflow-style overflow-x overflow-y padding padding-bottom padding-left padding-right padding-top page page-break-after page-break-before page-break-inside page-policy pause pause-after pause-before perspective perspective-origin phonemes pitch pitch-range play-during position presentation-level punctuation-trim quotes rendering-intent resize rest rest-after rest-before richness right rotation rotation-point ruby-align ruby-overhang ruby-position ruby-span size speak speak-header speak-numeral speak-punctuation speech-rate stress string-set table-layout target target-name target-new target-position text-align text-align-last text-decoration text-emphasis text-height text-indent text-justify text-outline text-shadow text-transform text-wrap top transform transform-origin transform-style transition transition-delay transition-duration transition-property transition-timing-function unicode-bidi vertical-align visibility voice-balance voice-duration voice-family voice-pitch voice-pitch-range voice-rate voice-stress voice-volume volume white-space white-space-collapse widows width word-break word-spacing word-wrap z-index".split(" "),
B={styleClass:"comment"},y={styleClass:"token_multiline_comment"},z={styleClass:"token_doc_comment"},C={styleClass:"token_doc_html_markup"},D={styleClass:"token_task_tag"},E={styleClass:"token_doc_tag"},s={styleClass:"token-string"},F={styleClass:"token_number"},G={styleClass:"token_keyword"},u={styleClass:"token_space"},v={styleClass:"token_tab"},H={styleClass:"line_caret"},M={styleCLass:"ruler.annotations"},I={styleCLass:"rulerLines"};q.prototype={getOffset:function(){return this.offset},getStartOffset:function(){return this.startOffset},
getData:function(){return this.text.substring(this.startOffset,this.offset)},getDataLength:function(){return this.offset-this.startOffset},_default:function(a){switch(a){case 32:case 9:if(this.whitespacesVisible)return 32===a?11:10;do a=this._read();while(32===a||9===a);this._unread(a);return 9;case 123:case 125:case 40:case 41:case 91:case 93:case 60:case 62:return a;default:var b=this.isCSS,d=this.offset-1;if(!b&&48<=a&&57>=a){var f=b=!1,c=!1,e=a;do if(a=this._read(),46===a&&!b)b=!0;else if(101===
a&&!f)b=f=!0,a=this._read(),45!==a&&this._unread(a);else if(120===a&&48===e&&2===this.offset-d)b=f=c=!0;else if(!(48<=a&&57>=a||c&&(65<=a&&70>=a||97<=a&&102>=a)))break;while(1);this._unread(a);return 3}if(97<=a&&122>=a||65<=a&&90>=a||95===a||45===a&&b){do a=this._read();while(97<=a&&122>=a||65<=a&&90>=a||95===a||48<=a&&57>=a||45===a&&b);this._unread(a);a=this.keywords;if(0<a.length){d=this.text.substring(d,this.offset);for(b=0;b<a.length;b++)if(this.keywords[b]===d)return 2}}return 1}},_read:function(){return this.offset<
this.text.length?this.text.charCodeAt(this.offset++):-1},_unread:function(a){-1!==a&&this.offset--},nextToken:function(){for(this.startOffset=this.offset;;){var a=this._read(),b;switch(a){case -1:return null;case 47:a=this._read();if(!this.isCSS&&47===a)for(;;)if(a=this._read(),-1===a||10===a||13===a)return this._unread(a),6;if(42===a){a=this._read();b=7;for(42===a&&(b=8);;){for(;42===a;)if(a=this._read(),47===a)return b;if(-1===a)return this._unread(a),b;a=this._read()}}this._unread(a);return 1;
case 39:for(b=4;;)switch(a=this._read(),a){case 39:return b;case 13:case 10:case -1:return this._unread(a),b;case 92:switch(a=this._read(),a){case 10:b=5;break;case 13:b=5,a=this._read(),10!==a&&this._unread(a)}}break;case 34:for(b=4;;)switch(a=this._read(),a){case 34:return b;case 13:case 10:case -1:return this._unread(a),b;case 92:switch(a=this._read(),a){case 10:b=5;break;case 13:b=5,a=this._read(),10!==a&&this._unread(a)}}break;default:return this._default(a)}}},setText:function(a){this.text=
a;this.startOffset=this.offset=0}};w.prototype=new q(null);w.prototype.nextToken=function(){for(this.startOffset=this.offset;;){var a=this._read();switch(a){case -1:return null;case 32:return 11;case 9:return 10;default:do a=this._read();while(!(32===a||9===a||-1===a));this._unread(a);return 1}}};t.prototype=new q(null);t.prototype.setType=function(a){this._type=a};t.prototype.nextToken=function(){for(this.startOffset=this.offset;;){var a=this._read();switch(a){case -1:return null;case 32:case 9:if(this.whitespacesVisible)return 32===
a?11:10;do a=this._read();while(32===a||9===a);this._unread(a);return 9;case 60:if(8===this._type){do a=this._read();while(!(62===a||-1===a));if(62===a)return 12}return 1;case 64:if(8===this._type){do a=this._read();while(97<=a&&122>=a||65<=a&&90>=a||95===a||48<=a&&57>=a);this._unread(a);return 13}return 1;case 84:if(79===(a=this._read()))if(68===(a=this._read()))if(79===(a=this._read()))if(a=this._read(),!(97<=a&&122>=a||65<=a&&90>=a||95===a||48<=a&&57>=a))return this._unread(a),14;this._unread(a);
default:do a=this._read();while(!(32===a||9===a||-1===a||60===a||64===a||84===a));this._unread(a);return 1}}};x.prototype=new q(null);x.prototype._default=function(a){for(;;)switch(a=this._read(),a){case 47:case 34:case 39:case -1:return this._unread(a),1}};A.prototype={getClassNameForToken:function(a){switch(a){case "singleLineComment":return B.styleClass;case "multiLineComment":return y.styleClass;case "docComment":return z.styleClass;case "docHtmlComment":return C.styleClass;case "tasktag":return D.styleClass;
case "doctag":return E.styleClass;case "string":return s.styleClass;case "number":return F.styleClass;case "keyword":return G.styleClass;case "space":return u.styleClass;case "tab":return v.styleClass;case "caretLine":return H.styleClass;case "rulerStyle":return"ruler";case "annotationsStyle":return M.styleClass;case "rulerFolding":return I.styleClass;case "rulerOverview":return"ruler.overview";case "rulerLines":return I.styleClass;case "rulerLinesEven":return"rulerLines.even";case "rulerLinesOdd":return"rulerLines.odd"}return null},
destroy:function(){var a=this.view;if(a){var b=a.getModel();b.getBaseModel&&(b=b.getBaseModel());b.removeEventListener("Changed",this._listener.onChanged);a.removeEventListener("MouseDown",this._listener.onMouseDown);a.removeEventListener("Selection",this._listener.onSelection);a.removeEventListener("Destroy",this._listener.onDestroy);a.removeEventListener("LineStyle",this._listener.onLineStyle);this.view=null}},setHighlightCaretLine:function(a){this.highlightCaretLine=a},setWhitespacesVisible:function(a){this.whitespacesVisible=
a;this._scanner.whitespacesVisible=a;this._commentScanner.whitespacesVisible=a},setDetectHyperlinks:function(a){this.detectHyperlinks=a},setFoldingEnabled:function(a){this.foldingEnabled=a},setDetectTasks:function(a){this.detectTasks=a},_binarySearch:function(a,b,d,f,c){var e;void 0===f&&(f=-1);void 0===c&&(c=a.length);for(;1<c-f;)if(e=Math.floor((c+f)/2),b<=a[e].start)c=e;else if(d&&b<a[e].end){c=e;break}else f=e;return c},_computeComments:function(){var a=this.view.getModel();a.getBaseModel&&(a=
a.getBaseModel());this.comments=this._findComments(a.getText())},_computeFolding:function(){if(this.foldingEnabled){var a=this.view.getModel();if(a.getBaseModel){var b=this.annotationModel;if(b){b.removeAnnotations(r.AnnotationType.ANNOTATION_FOLDING);for(var d=[],f=a.getBaseModel(),c=this.comments,e=0;e<c.length;e++){var h=c[e];(h=this._createFoldingAnnotation(a,f,h.start,h.end))&&d.push(h)}b.replaceAnnotations(null,d)}}}},_createFoldingAnnotation:function(a,b,d,f){var c=b.getLineAtOffset(d);b=b.getLineAtOffset(f);
return c===b?null:new (r.AnnotationType.getType(r.AnnotationType.ANNOTATION_FOLDING))(d,f,a)},_computeTasks:function(a,b,d){if(this.detectTasks){var f=this.annotationModel;if(f){var c=this.view.getModel(),e=c;c.getBaseModel&&(e=c.getBaseModel());for(var h=f.getAnnotations(b,d),c=[],g=r.AnnotationType.ANNOTATION_TASK;h.hasNext();){var k=h.next();k.type===g&&c.push(k)}h=[];k=this._commentScanner;k.setText(e.getText(b,d));for(var l;l=k.nextToken();){var n=k.getStartOffset()+b;14===l&&(l=e.getLineEnd(e.getLineAtOffset(n)),
6!==a&&(l=Math.min(l,d-this.commentEnd.length)),h.push(r.AnnotationType.createAnnotation(g,n,l,e.getText(n,l))))}f.replaceAnnotations(c,h)}}},_getLineStyle:function(a){if(this.highlightCaretLine){var b=this.view,d=b.getModel(),b=b.getSelection();if(b.start===b.end&&d.getLineAtOffset(b.start)===a)return H}return null},_getStyles:function(a,b,d){a.getBaseModel&&(d=a.mapOffset(d));for(var f=d+b.length,c=[],e=d,h=this.comments,g=this._binarySearch(h,d,!0);g<h.length&&!(h[g].start>=f);g++){var k=h[g].start,
l=h[g].end;e<k&&this._parse(b.substring(e-d,k-d),e,c);var n=h[g].type,p;switch(n){case 8:p=z;break;case 7:p=y;break;case 5:p=s}e=Math.max(e,k);k=Math.min(f,l);(8===n||7===n)&&(this.whitespacesVisible||this.detectHyperlinks)?this._parseComment(b.substring(e-d,k-d),e,c,p,n):5===n&&this.whitespacesVisible?this._parseString(b.substring(e-d,k-d),e,c,s):c.push({start:e,end:k,style:p});e=l}e<f&&this._parse(b.substring(e-d,f-d),e,c);if(a.getBaseModel)for(b=0;b<c.length;b++)d=c[b].end-c[b].start,c[b].start=
a.mapOffset(c[b].start,!0),c[b].end=c[b].start+d;return c},_parse:function(a,b,d){var f=this._scanner;for(f.setText(a);a=f.nextToken();){var c=f.getStartOffset()+b,e=null;switch(a){case 2:e=G;break;case 3:e=F;break;case 5:case 4:if(this.whitespacesVisible){this._parseString(f.getData(),c,d,s);continue}else e=s;break;case 8:this._parseComment(f.getData(),c,d,z,a);continue;case 6:this._parseComment(f.getData(),c,d,B,a);continue;case 7:this._parseComment(f.getData(),c,d,y,a);continue;case 10:this.whitespacesVisible&&
(e=v);break;case 11:this.whitespacesVisible&&(e=u)}d.push({start:c,end:f.getOffset()+b,style:e})}},_parseComment:function(a,b,d,f,c){var e=this._commentScanner;e.setText(a);for(e.setType(c);a=e.nextToken();){c=e.getStartOffset()+b;var h=f;switch(a){case 10:this.whitespacesVisible&&(h=v);break;case 11:this.whitespacesVisible&&(h=u);break;case 12:h=C;break;case 13:h=E;break;case 14:h=D;break;default:this.detectHyperlinks&&(h=this._detectHyperlinks(e.getData(),c,d,h))}h&&d.push({start:c,end:e.getOffset()+
b,style:h})}},_parseString:function(a,b,d,f){var c=this._whitespaceScanner;for(c.setText(a);a=c.nextToken();){var e=c.getStartOffset()+b,h=f;switch(a){case 10:this.whitespacesVisible&&(h=v);break;case 11:this.whitespacesVisible&&(h=u)}h&&d.push({start:e,end:c.getOffset()+b,style:h})}},_detectHyperlinks:function(a,b,d,f){var c=null,e;if(0<(e=a.indexOf("://"))){for(var c=a,h=e;0<h;){e=c.charCodeAt(h-1);if(!(97<=e&&122>=e||65<=e&&90>=e||45===e||48<=e&&57>=e))break;h--}if(0<h&&(e="\"\"''(){}[]\x3c\x3e".indexOf(c.substring(h-
1,h)),-1!==e&&0===(e&1)&&-1!==(e=c.lastIndexOf("\"\"''(){}[]\x3c\x3e".substring(e+1,e+2))))){var g=e;e=this._clone(f);e.tagName="A";e.attributes={href:c.substring(h,g)};d.push({start:b,end:b+h,style:f});d.push({start:b+h,end:b+g,style:e});d.push({start:b+g,end:b+a.length,style:f});return null}}else 0===a.toLowerCase().indexOf("bug#")&&(c="https://bugs.eclipse.org/bugs/show_bug.cgi?id\x3d"+parseInt(a.substring(4),10));return c?(e=this._clone(f),e.tagName="A",e.attributes={href:c},e):f},_clone:function(a){if(!a)return a;
var b={},d;for(d in a)a.hasOwnProperty(d)&&(b[d]=a[d]);return b},_findComments:function(a,b){b=b||0;var d=this._firstScanner,f;d.setText(a);for(var c=[];f=d.nextToken();)(7===f||8===f||5===f)&&c.push({start:d.getStartOffset()+b,end:d.getOffset()+b,type:f}),(6===f||7===f||8===f)&&this._computeTasks(f,d.getStartOffset()+b,d.getOffset()+b);return c},_findMatchingBracket:function(a,b){var d="{}()[]\x3c\x3e",f=a.getText(b,b+1),c=d.indexOf(f,0);if(-1===c)return-1;var e;e=c&1?d.substring(c-1,c):d.substring(c+
1,c+2);for(var h=a.getLineAtOffset(b),d=a.getLine(h),g=a.getLineStart(h),k=a.getLineEnd(h),d=this._findBrackets(f,e,d,g,g,k),k=0;k<d.length;k++)if(g=0<=d[k]?1:-1,d[k]*g-1===b){var l=1;if(c&1){for(k--;0<=k;k--)if(g=0<=d[k]?1:-1,l+=g,0===l)return d[k]*g-1;for(h-=1;0<=h;){d=a.getLine(h);g=a.getLineStart(h);k=a.getLineEnd(h);d=this._findBrackets(f,e,d,g,g,k);for(c=d.length-1;0<=c;c--)if(g=0<=d[c]?1:-1,l+=g,0===l)return d[c]*g-1;h--}}else{for(k++;k<d.length;k++)if(g=0<=d[k]?1:-1,l+=g,0===l)return d[k]*
g-1;h+=1;for(c=a.getLineCount();h<c;){d=a.getLine(h);g=a.getLineStart(h);k=a.getLineEnd(h);d=this._findBrackets(f,e,d,g,g,k);for(k=0;k<d.length;k++)if(g=0<=d[k]?1:-1,l+=g,0===l)return d[k]*g-1;h++}}break}return-1},_findBrackets:function(a,b,d,f,c,e){var h=[];a=a.charCodeAt(0);b=b.charCodeAt(0);for(var g=c,k=this._scanner,l,n=this.comments,p=this._binarySearch(n,c,!0);p<n.length&&!(n[p].start>=e);p++){l=n[p].start;var m=n[p].end;if(g<l)for(k.setText(d.substring(g-c,l-c));l=k.nextToken();)l===a?h.push(k.getStartOffset()+
g-c+f+1):l===b&&h.push(-(k.getStartOffset()+g-c+f+1));g=m}if(g<e)for(k.setText(d.substring(g-c,e-c));l=k.nextToken();)l===a?h.push(k.getStartOffset()+g-c+f+1):l===b&&h.push(-(k.getStartOffset()+g-c+f+1));return h},_onDestroy:function(a){this.destroy()},_onLineStyle:function(a){a.textView===this.view&&(a.style=this._getLineStyle(a.lineIndex));a.ranges=this._getStyles(a.textView.getModel(),a.lineText,a.lineStart)},_onSelection:function(a){var b=a.oldValue,d=a.newValue,f=this.view;a=f.getModel();var c;
if(this.highlightCaretLine){var e=a.getLineAtOffset(b.start);c=a.getLineAtOffset(d.start);var h=d.start===d.end,b=b.start===b.end;e===c&&b&&h||(b&&f.redrawLines(e,e+1),(e!==c||!b)&&h&&f.redrawLines(c,c+1))}if(this.annotationModel){var b=this._bracketAnnotations,g,k;if(d.start===d.end&&0<(k=f.getCaretOffset()))k-=1,a.getBaseModel&&(k=a.mapOffset(k),a=a.getBaseModel()),a=this._findMatchingBracket(a,k),-1!==a&&(g=[r.AnnotationType.createAnnotation(r.AnnotationType.ANNOTATION_MATCHING_BRACKET,a,a+1),
r.AnnotationType.createAnnotation(r.AnnotationType.ANNOTATION_CURRENT_BRACKET,k,k+1)]);this._bracketAnnotations=g;this.annotationModel.replaceAnnotations(b,g)}},_onMouseDown:function(a){if(2===a.clickCount){var b=this.view,d=b.getModel(),f=b.getOffsetAtLocation(a.x,a.y);if(0<f){var c=f-1,e=d;d.getBaseModel&&(c=d.mapOffset(c),e=d.getBaseModel());c=this._findMatchingBracket(e,c);-1!==c&&(a.preventDefault(),a=c,d.getBaseModel&&(a=d.mapOffset(a,!0)),f>a&&(f--,a++),b.setSelection(a,f))}}},_onModelChanged:function(a){var b=
a.start,d=a.removedCharCount,f=a.addedCharCount-d,c=this.view;a=c.getModel();var e=a.getBaseModel?a.getBaseModel():a,d=b+d,h=e.getCharCount(),g=this.comments.length,k=e.getLineStart(e.getLineAtOffset(b)),l=this._binarySearch(this.comments,k,!0),n=this._binarySearch(this.comments,d,!1,l-1,g);l<g&&this.comments[l].start<=k&&k<this.comments[l].end?(k=this.comments[l].start,k>b&&(k+=f)):k=l===g&&0<g&&h-f===this.comments[g-1].end?this.comments[g-1].start:k;var p;n<g?(p=this.comments[n].end,p>b&&(p+=f),
n+=1):(n=g,p=h);for(var h=e.getText(k,p),m,h=this._findComments(h,k),g=l;g<this.comments.length;g++)m=this.comments[g],m.start>b&&(m.start+=f),m.start>b&&(m.end+=f);var q=n-l!==h.length;if(!q)for(g=0;g<h.length;g++){m=this.comments[l+g];var s=h[g];if(m.start!==s.start||m.end!==s.end||m.type!==s.type){q=!0;break}}g=[l,n-l].concat(h);Array.prototype.splice.apply(this.comments,g);q&&(g=k,m=p,a!==e&&(g=a.mapOffset(g,!0),m=a.mapOffset(m,!0)),c.redrawRange(g,m));if(this.foldingEnabled&&e!==a&&this.annotationModel){c=
this.annotationModel;l=c.getAnnotations(k,p);k=[];for(p=[];l.hasNext();)if(m=l.next(),m.type===r.AnnotationType.ANNOTATION_FOLDING){p.push(m);for(g=0;g<h.length&&!(m.start===h[g].start&&m.end===h[g].end);g++);g===h.length?(k.push(m),m.expand()):(g=m.start,n=m.end,g>b&&(g-=f),n>b&&(n-=f),g<=b&&(b<n&&g<=d&&d<n)&&(g=e.getLineAtOffset(m.start),n=e.getLineAtOffset(m.end),g!==n?m.expanded||(m.expand(),c.modifyAnnotation(m)):c.removeAnnotation(m)))}b=[];for(g=0;g<h.length;g++){m=h[g];for(f=0;f<p.length&&
!(p[f].start===m.start&&p[f].end===m.end);f++);f===p.length&&(m=this._createFoldingAnnotation(a,e,m.start,m.end))&&b.push(m)}c.replaceAnnotations(k,b)}}};return{TextStyler:A}});
//# sourceMappingURL=TextStyler.js.map