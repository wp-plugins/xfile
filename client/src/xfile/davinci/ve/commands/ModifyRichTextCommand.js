//>>built
define("davinci/ve/commands/ModifyRichTextCommand",["dojo/_base/declare"],function(e){return e("davinci.ve.commands.ModifyRichTextCommand",null,{name:"modify",constructor:function(a,b,d,c){this._oldId=a?a.id:void 0;this._properties=b=b||{};b.richText?(this._richText=!0,this._children=this._newText=b.richText,delete b.richText):this._children=b._children;this._context=c||a.getContext()},setContext:function(a){this._context=a},add:function(a){a&&a._oldId==this._oldId&&(a._properties&&dojo.mixin(this._properties,
a._properties),a._children&&(this._children=a._children))},execute:function(){if(this._oldId&&this._properties){var a=require("davinci/ve/widget"),b=a.byId(this._oldId);if(b){this._parentWidget=b.getParent();if(!this._oldText&&(this._oldText=b._srcElement.getElementText(this._context))&&"string"==typeof this._oldText)this._oldText=this._oldText.replace(/\n/g,"");this._oldData||(this._oldData=b.getData(),this._oldData.context=this._context,this._newData={type:this._oldData.type,properties:dojo.mixin({},
this._oldData.properties,this._properties),children:this._newText,maqStates:this._oldData.maqStates,maqDeltas:this._oldData.maqDeltas,context:this._context},this._oldData={type:this._oldData.type,properties:dojo.mixin({},this._oldData.properties,this._properties),children:this._oldText,maqStates:this._oldData.maqStates,maqDeltas:this._oldData.maqDeltas,context:this._context});var d=this._context;d&&d.detach(b);this._properties.id&&delete this._newData.properties.isTempID;this._newId_isTempID||(this._newId_isTempID=
this._newData.properties.isTempID);this._oldId_isTempID||(this._oldId_isTempID=this._oldData.properties.isTempID);var c=null,e=this._parentWidget.indexOf(b);this._parentWidget.removeChild(b);b.destroyWidget();this._newId&&(this._newData.properties.id=this._newId);this._newId_isTempID&&(this._newData.properties.isTempID=this._newId_isTempID);if(c=a.createWidget(this._newData))this._parentWidget.addChild(c,e),this._newId=c.id,this._context&&this._refresh(c),d&&(d.widgetAddedOrDeleted(),this._oldId!=
this._newId&&d.widgetChanged(d.WIDGET_ID_CHANGED,c,this._oldId),d.widgetChanged(d.WIDGET_MODIFIED,c)),this.newWidget=c,dojo.publish("/davinci/ui/widget/replaced",[c,b]),require("davinci/ve/States").resetState(c.domNode)}}},undo:function(){if(this._newId&&this._oldData){var a=require("davinci/ve/widget"),b=a.byId(this._newId);if(b){var d=dojo.indexOf(this._parentWidget.getChildren(),b);if(!(0>d)){var c=this._parentWidget.getContext();c&&c.detach(b);this._parentWidget.removeChild(b);b.destroyWidget();
this._oldData.children=this._oldText;this._oldData.properties.id=this._oldId;a=a.createWidget(this._oldData);this._parentWidget.addChild(a,d);c&&this._refresh(a);c.widgetAddedOrDeleted();c.widgetChanged(c.WIDGET_MODIFIED,a);dojo.publish("/davinci/ui/widget/replaced",[a,b]);require("davinci/ve/States").resetState(a.domNode)}}}},_refresh:function(a){var b=a.getContainerNode();b&&this._context.getGlobal().require("dojo/parser").parse(b);this._context.attach(a);a.startup();a.renderWidget();b&&this._context._attachChildren(b)}})});
//# sourceMappingURL=ModifyRichTextCommand.js.map