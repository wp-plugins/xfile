//>>built
define("davinci/_WorkbenchImpl","dojo/_base/lang require ./Runtime ./model/Path ./workbench/ViewPart ./workbench/EditorContainer ./ui/Dialog dijit/Toolbar dijit/ToolbarSeparator dijit/Menu dijit/MenuBar dijit/MenuItem dijit/MenuSeparator dijit/PopupMenuBarItem dijit/form/Button dijit/form/DropDownButton dijit/form/ComboButton dijit/form/ToggleButton dijit/layout/BorderContainer dijit/layout/StackController dijit/layout/StackContainer dijit/layout/ContentPane dijit/layout/TabController dijit/layout/TabContainer system/resource dojo/i18n!./nls/webContent ./ve/metadata dojo/Deferred dojo/promise/all dojo/_base/declare dojo/_base/connect dojo/_base/xhr ./review/model/resource/root dojo/i18n!./ve/nls/common ./ve/utils/GeomUtils dojo/i18n!./ui/nls/common davinci/review/model/resource/root xide/manager/ServerActionBase".split(" "),
function(S,C,k,x,T,U,D,V,W,H,X,I,Y,Z,$,M,aa,ba,y,oa,J,E,pa,K,ca,v,N,F,da,ea,O,fa,ga,P,ha,Q,ia,ja){var t={};Function.prototype.bind=Function.prototype.bind||function(a){return dojo.hitch(a,this)};var z=function(a){return"editor-"+encodeURIComponent(a.replace(/[\/| |\t]/g,"_")).replace(/%/g,":")},w=function(a){return a.replace(/^editor/,"shadow")},L=function(a){return a.replace(/^shadow/,"editor")},la=function(a,b){if(401==b.status||403==b.status)ka();else if(!0===a.canceled){var d=a.ioArgs.url;RegExp("(^|\\.\\/|"+
document.baseURI+"\\/)cmd\\/").test(d)&&(0<=d.indexOf("getBluePageInfo")||k.handleError(b.message))}},ka=function(){var a=new D({title:v.sessionTimedOut}),b=dojo.string.substitute(v.sessionTimedOutMsg,{hrefLoc:"welcome"});a.set("content",b);dojo.connect(a,"onCancel",null,function(){window.location.href="welcome"});setTimeout(function(){window.location.href="welcome"},1E4);a.show()},ma=function(){davinci.Workbench._expandCollapsePaletteContainers(null,{dontPreserveWidth:!0});var a=function(a){dojo.publish("/davinci/ui/initialPerspectiveReady",
[]);a.project&&c.setActiveProject(a.project);if(a.editors){a.version=davinci.version;var b,d=c.singleProjectMode();d&&(b=new x(c.getProject()));a.editors.forEach(function(g){var l=-1<g.indexOf(".review");if(l||!d||(new x(g)).startsWith(b)){var m=function(l){var m=!0;d&&((new x(a.activeEditor)).startsWith(b)||(m=!1));var s=g!=a.activeEditor;s&&(!m&&!(-1<a.activeEditor.indexOf(".review")))&&(s=!1,a.activeEditor=g);l&&c.openEditor({fileName:l,noSelect:s,isDirty:l.isDirty(),startup:!1,initializationTime:!0})};
if(l){var l=(new x(g)).segment(2),k=(new x(g)).removeFirstSegments(3).toString();ga.findFile(l,k).then(function(a){m(a)})}else m(ca.findResource(g))}})}else a.editors=[]};c._state||(c._state=k.getWorkbenchState());var b=dojo.cookie("davinci_designer"),d=dojo.cookie("davinci_version");dojo.cookie("davinci_designer",null,{expires:-1,path:"/"});dojo.cookie("davinci_version",null,{expires:-1,path:"/"});d&&b?ia.findVersion(b,d).then(function(b){b&&b.getChildren(function(b){b.forEach(function(a,b){var d=
a.getPath();0==b&&(c._state.activeEditor=d);0>c._state.editors.indexOf(d)&&c._state.editors.push(d)}.bind(this));a(c._state)})}.bind(this)):a(c._state);c.setupGlobalKeyboardHandler()},c={activePerspective:"",actionScope:[],_DEFAULT_PROJECT:"project1",hideEditorTabs:!0,_editorTabClosing:{},_shadowTabClosing:{},service:null,serviceClass:"XApp_XIDE_Workbench_Service",initService:function(){console.error("init workbench service");this.service||(this.service=new ja({serviceClass:"XApp_XIDE_Workbench_Service",
serviceUrl:"../xapp/xcf/xui.php?debug\x3dtrue\x26view\x3drpc",singleton:!1}),this.service.init())},run:function(){k.run();c._initKeys();c._baseTitle=dojo.doc.title;try{c.initService()}catch(a){debugger}window.maqetta&&(maqetta.TopBanner&&maqetta.TopBanner.setup)&&maqetta.TopBanner.setup();k.subscribe("/davinci/resource/resourceChanged",function(a,b){if("deleted"==a){var e=z(b.getPath()),c=w(e),e=dijit.byId(e),c=dijit.byId(c);if(e&&!e._isClosing){var g=dijit.byId("editors_container"),l=dijit.byId("davinci_file_tabs");
g.removeChild(e);e.destroyRecursive();l.removeChild(c);c.destroyRecursive()}}});k.subscribe("/dojo/io/error",la);k.subscribe("/davinci/states/state/changed",function(a){var b=k.currentEditor;"davinci.ve.themeEditor.ThemeEditor"!=b.declaredClass&&"davinci.review.editor.ReviewEditor"!=b.declaredClass&&b.visualEditor.onContentChange.apply(b.visualEditor,arguments)});k.subscribe("/davinci/ui/widgetPropertiesChanges",function(){var a=k.currentEditor.visualEditor;a._objectPropertiesChange.apply(a,arguments)});
O.subscribe("/davinci/states/state/changed",function(a){var b=k.currentEditor&&"davinci.ve.PageEditor"==k.currentEditor.declaredClass&&k.currentEditor.visualEditor&&k.currentEditor.visualEditor.context;if(b){var e,c,b=b?b.getDijit():null,g=C("davinci/ve/widget");a.newState&&!a.newState.indexOf("_show:")&&(e=b.byId(a.newState.substring(6)),e=g.getWidget(e.domNode),(c=e.getHelper())&&c.popup&&c.popup(e));a.oldState&&!a.oldState.indexOf("_show:")&&(e=b.byId(a.oldState.substring(6)),e=g.getWidget(e.domNode),
(c=e.getHelper())&&c.tearDown&&c.tearDown(e))}});O.subscribe("/davinci/ui/repositionFocusContainer",function(a){c._repositionFocusContainer()});var b=this.service.serviceObject[this.serviceClass].getInfo().then(function(a){k._initializationInfo=a;a=a.userInfo;k.isLocalInstall="maqettaUser"==a.userId;k.userName=a.userId;k.userEmail=a.email;return N.init()}).then(function(){var a=k.initialPerspective||"davinci.ui.main";dojo.query(".loading").orphan();c.showPerspective(a);c._updateTitle();ma()}).otherwise(function(a){dojo.query("#load_screen").addContent(dojo.string.substitute(v.startupError,
[a.message]),"only")});c._lastAutoSave=Date.now();setInterval(dojo.hitch(this,"_autoSave"),3E4);return b},unload:function(){c._autoSave()},logoff:function(a){dojo.create("div",{"class":"loading",innerHTML:"\x3ctable\x3e\x3ctr\x3e\x3ctd\x3e\x3cspan\x3e\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;\x3c/span\x3e\x26nbsp;Logging off...\x3c/td\x3e\x3c/tr\x3e\x3c/table\x3e"},dojo.body(),"first");c.unload();return fa.get({url:"cmd/logoff",handleAs:"text"}).then(function(a){location.href="welcome"})},_createToolBar:function(a,
b,d,n){var e=[];d||(d=k.getExtensions("davinci.actionSets"));for(var f=0,g=d.length;f<g;f++)for(var l=d[f].actions,m=0,q=l.length;m<q;m++){var h=l[m],p=h[a];p&&(e[p]||(e[p]=[]),e[p].push(h))}var s=new V({"class":"davinciToolbar"},b);a={};b=!0;for(var G in e)if(dojo.isArray(e[G])){b?b=!1:(l=new W,s.addChild(l));l=e[G];for(d=0;d<l.length;d++){h=l[d];if(null==h)debugger;c._loadActionClass(h);var u={showLabel:!1};["label","showLabel","iconClass"].forEach(function(a){h.hasOwnProperty(a)&&(u[a]=h[a])});
h.className&&(u["class"]=h.className);var r,A=new F;if(h.menu&&("DropDownButton"==h.type||"ComboButton"==h.type)){f=new H({style:"display: none;"});for(g=0;g<h.menu.length;g++){var B=h.menu[g];c._loadActionClass(B);var R={onClick:dojo.hitch(this,"_runAction",B,n)};["label","iconClass"].forEach(function(a){B[a]&&(R[a]=B[a])});m=new I(R);m._maqAction=B;f.addChild(m)}u.dropDown=f;r="DropDownButton"==h.type?new M(u):new aa(u);r.onClick=dojo.hitch(this,"_runAction",h,n);r._maqAction=h;A.resolve()}else h.toggle||
h.radioGroup?(r=new ba(u),r.item=h,r.set("checked",h.initialValue),h.radioGroup?((f=a[h.radioGroup])||(f=a[h.radioGroup]=[]),f.push(r),r.onChange=dojo.hitch(this,"_toggleButton",r,n,f)):r.onChange=dojo.hitch(this,"_runAction",h,n),r._maqAction=h,A.resolve()):h.type?C([h.type],function(a){r=new a;r._maqActiond=h;A.resolve()}):(r=new $(u),r.onClick=dojo.hitch(this,"_runAction",h,n),r._maqAction=h,A.resolve());h.icon&&(f=document.createElement("img"),f.src=h.icon,f.height=f.width=18,r.domNode.appendChild(f));
A.then(function(){s.addChild(r);h.isEnabled&&!h.isEnabled()?(r.isEnabled=h.isEnabled,r.set("disabled",!0)):r.set("disabled",!1)})}}return s},showPerspective:function(a){c.activePerspective=a;var b=c._createMenuTree();c._updateMainMenubar(dojo.byId("davinci_main_menu"),b);b=this.getActionSets("davinci.ui.editorMenuBar").clonedActionSets;b.length&&(b=c._createMenuTree(b),c._updateMainMenubar(dojo.byId("maq_banner_editor_commands"),b));b=dojo.byId("mainBody");b.tabs||(b.tabs=[]);var d=dijit.byId("mainBody");
d||(d=new y({gutters:!1,region:"center",design:"sidebar"},b));var n=k.getExtension("davinci.perspective",a);n||k.handleError(dojo.string.substitute(v.perspectiveNotFound,[a]));var n=dojo.clone(n),e=k.getExtensions("davinci.perspectiveExtension",function(b){return b.targetID===a});dojo.forEach(e,function(a){dojo.forEach(a.views,function(a){n.views.push(a)})});b.editorsStackContainer||(c.editorsStackContainer=b.editorsStackContainer=new J({region:"center",id:"editorsStackContainer",controllerWidget:"dijit.layout.StackController"}));
d.addChild(b.editorsStackContainer);b.editorsWelcomePage||(c.editorsWelcomePage=b.editorsWelcomePage=new E({id:"editorsWelcomePage",href:"app/davinci/ve/resources/welcome_to_maqetta.html"}));b.editorsStackContainer.addChild(b.editorsWelcomePage);b.tabs.editors||(c.editorTabs=b.tabs.editors=new (c.hideEditorTabs?J:K)({id:"editors_container",controllerWidget:c.hideEditorTabs?"dijit.layout.StackController":"dijit.layout.TabController"}),c.editorTabs.setTitle=function(a,b){a.attr("title",b);a.domNode.title=
"";if(c.hideEditorTabs){var d=w(a.id);dijit.byId("davinci_file_tabs").tablist.pane2button[d].attr("label",b+(a.isDirty?'\x3cspan class\x3d"dirtyFileAsterisk"\x3e\x3c/span\x3e':""))}else this.tablist.pane2button[a.id].attr("label",b)},dojo.connect(b.tabs.editors,"removeChild",this,c._editorTabClosed));b.editorsStackContainer.addChild(b.tabs.editors);b.editorsStackContainer.selectChild(b.editorsWelcomePage);dojo.connect(dijit.byId("editors_container"),"selectChild",function(a){if(!c._processingSelectChild){c._processingSelectChild=
!0;var b=w(a.id),b=dijit.byId(b),d=dijit.byId("davinci_file_tabs");b&&d&&d.selectChild(b);a.editor&&c._switchEditor(a.editor);c._processingSelectChild=!1}});d.startup();var f=dijit.byId("davinci_app");if(!f){var f=new y({design:"headline",gutters:!1,liveSplitters:!1},"davinci_app"),e=new E({region:"top",layoutPriority:1},"davinci_top_bar"),g=c.mainStackContainer=b.editorsStackContainer=new J({region:"center",id:"mainStackContainer",controllerWidget:"dijit.layout.StackController"}),l=c.mainBorderContainer=
new y({design:"headline",gutters:!1,id:"mainBorderContainer",liveSplitters:!1}),m=c.shadowTabs=new K({id:"davinci_file_tabs",closable:!0,region:"top",layoutPriority:1,style:"display:none"});c.shadowTabs.setTitle=function(a,b){a.attr("title",b);this.tablist.pane2button[a.id].attr("label",b)};dojo.connect(m,"selectChild",function(a){a=L(a.id);a=dijit.byId(a);var b=dijit.byId("editors_container");b&&(a&&a.editor)&&b.selectChild(a)});dojo.connect(m,"removeChild",this,c._shadowTabClosed);var q=new E({id:"davinci_toolbar_pane",
region:"top",layoutPriority:1,content:'\x3cdiv id\x3d"davinci_toolbar_container"\x3e\x3c/div\x3e',style:"display:none"});f.addChild(e);f.addChild(g);g.addChild(l);g.selectChild(l);l.addChild(m);l.addChild(q);l.addChild(d);f.layout();f.startup();c._originalOnResize=window.onresize;window.onresize=c.onResize;dojo.connect(d,"onMouseUp",this,"onResize");(d=dijit.byId("davinci_file_tabs_tablist_Menu"))&&d.addChild(new dijit.MenuItem({label:P.closeAllEditors,onClick:this.closeAllEditors}))}for(var h in b.tabs.perspective){var p=
b.tabs.perspective[h];p&&(dojo.forEach(p.getChildren(),function(a){p.removeChild(a);"left"!=h&&"right"!=h&&a.destroyRecursive(!1)}),p.destroyRecursive(!1),delete b.tabs.perspective[h])}this._showViewPromises=dojo.map(n.views,function(a){return c.showView(a.viewID,a.selected,a.hidden)},this);davinci.Workbench.focusContainer=dojo.create("div",{"class":"focusContainer",id:"focusContainer"},document.body);setTimeout(function(){f.resize();dojo.publish("/davinci/workbench/ready",[])}.bind(this),3E3)},onResize:function(a){var b=
a.explicitOriginalTarget?a.explicitOriginalTarget:a.srcElement;if("resize"==a.type||b.id&&-1<b.id.indexOf("dijit_layout__Splitter_")||b.nextSibling&&b.nextSibling.id&&-1<b.nextSibling.id.indexOf("dijit_layout__Splitter_"))if((a=davinci&&k.currentEditor)&&a.onResize)a.onResize();c._originalOnResize&&c._originalOnResize();c._repositionFocusContainer()},updateMenubar:function(a,b){var d=c._createMenuTree(b),n=dijit.byId(a.id);n||(n=new X({"class":"dijitInline"},a));c._addItemsToMenubar(d,n)},_updateMainMenubar:function(a,
b){for(var d=0;d<b.length;d++)for(var n=b[d],e=0;e<n.menus.length;e++){var f=n.menus[e],g=c._createMenu(f);f.id=f.id.replace(".","-");if(window.maqetta&&maqetta.TopBanner&&maqetta.TopBanner.attachMenu)maqetta.TopBanner.attachMenu(f,g,a);else{var l=dijit.byId(f.id+"-dropdown");l||(g={label:f.label,dropDown:g,id:f.id+"-dropdown"},f.hasOwnProperty("showLabel")&&(g.showLabel=f.showLabel),f.hasOwnProperty("iconClass")&&(g.iconClass=f.iconClass),f.hasOwnProperty("className")&&(g["class"]=f.className),l=
new M(g),a.appendChild(l.domNode))}}},_addItemsToMenubar:function(a,b){dojo.forEach(a,function(a){a=a.menus;a.length&&dojo.forEach(a,function(a){a.id=a.id.replace(/\./g,"-");var d=c._createMenu(a),f=dijit.byId(a.id+"-dropdown");f||(f=new Z({label:a.label,popup:d,id:a.id+"-dropdown"}));b.addChild(f)},this)},this)},getOpenEditor:function(a){return null!=a?(a=dijit.byId(z(a.getPath())))?a.editor:null:(a=dijit.byId("editors_container"))&&a.selectedChildWidget&&a.selectedChildWidget.editor?a.selectedChildWidget.editor:
null},closeActiveEditor:function(){var a=dijit.byId("editors_container"),b=dijit.byId("davinci_file_tabs");if(a&&a.selectedChildWidget&&a.selectedChildWidget.editor){var d=w(selectedChildWidget.id);a.closeChild(a.selectedChildWidget);(a=dijit.byId(d))&&b.closeChild(a)}},closeAllEditors:function(){var a=dijit.byId("editors_container");a&&a.getChildren().forEach(function(b){a.closeChild(b)})},getAllOpenEditorIds:function(){},showModal:function(a,b,d,c,e,f){return D.showModal(a,b,d,c,e,f)},showMessage:function(a,
b,d,c,e){return D.showMessage(a,b,d,c,e)},showDialog:function(a){return D.showDialog(a)},_createMenuTree:function(a,b){function d(a,b,d){b=(b||"additions").split("/");var e=n;c._loadActionClass(a);var g=b[b.length-1];if(1<b.length)for(var f=0,l=b.length-1;f<l;f++){var m;a:{m=0;for(var h=e.length;m<h;m++)for(var k=0,p=e[m].menus.length;k<p;k++)if(b[f]==e[m].menus[k].id){m=e[m].menus[k].menus;break a}m=void 0}m&&(e=m)}f=0;for(l=e.length;f<l;f++)if(e[f].id==g){b=e[f].menus;b.push(a);if(a.separator){d=
!1;b=a.menus=[];for(e=0;e<a.separator.length;e+=2)g=a.separator[e],d="additions"==g,b.push({id:g,isSeparator:a.separator[e+1],menus:[]});d||b.push({id:"additions",isSeparator:!1,menus:[]})}return}d&&n.push({id:g,isSeparator:!1,menus:[a]})}a||(a=k.getExtensions("davinci.actionSets",function(a){return 0==k.getExtensions("davinci.actionSetPartAssociations",function(b){return b.targetID==a.id}).length}));for(var n=[],e=0,f=a.length;e<f;e++){var g=a[e];if(g.visible&&g.menu)for(var l=0,m=g.menu.length;l<
m;l++){var q=g.menu[l];if(q.__mainMenu)for(var h=0;h<q.separator.length;h+=2)n.push({id:q.separator[h],isSeparator:q.separator[h+1],menus:[]});else if(d(q,q.path,b),q.populate instanceof Function){var q=q.populate(),p;for(p in q)d(q[p],q[p].menubarPath)}}}e=0;for(f=a.length;e<f;e++)if(g=a[e],g.visible){l=0;for(m=g.actions.length;l<m;l++)p=g.actions[l],p.menubarPath&&d(p,p.menubarPath,b)}return n},_loadActionClass:function(a){a&&"string"==typeof a.action&&C([a.action],function(b){try{if(b)a.action=
new b,a.action.item=a;else debugger}catch(d){console.error("action class creation failed : "+a.action)}})},_createMenu:function(a,b){var d,c,e;a.menus?(d=new H({parentMenu:a}),c=a.menus,e="onOpen"):(d=new na({}),c=a,e="menuOpened");d.domNode.style.display="none";d.actionContext=b;this._rebuildMenu(d,c);dojo.connect(d,e,this,function(a){d._widgetCallback&&d._widgetCallback(a);this._rebuildMenu(d,c).focus()});return d},singleProjectMode:function(){return!0},getProject:function(){return c.getActiveProject()||
c._DEFAULT_PROJECT},loadProject:function(a){c.setActiveProject(a);return c.updateWorkbenchState().then(function(){location.href="cmd/configProject?configOnly\x3dtrue\x26project\x3d"+encodeURIComponent(a)})},location:function(){return k.location()},_rebuildMenu:function(a,b){dojo.forEach(a.getChildren(),function(b){a.removeChild(b);b.destroy()});a.focusedChild=null;var d,n;b.forEach(function(b,f){b.menus.length&&(b.isSeparator&&0<f&&(d=!0),b.menus.forEach(function(b){d&&n&&(a.addChild(new Y({})),d=
!1);n=!0;var e=b.label;b.action&&b.action.getName&&(e=b.action.getName());if(b.separator)b=c._createMenu(b),b=new I({label:e,popup:b,id:b.id+"item"}),b.actionContext=a.actionContext,a.addChild(b);else{var f=!0;b.isEnabled&&(f=k.getSelection(),f=(f=f[0]&&f[0].resource)?b.isEnabled(f):!1);if(b.action){if(b.action.shouldShow&&!b.action.shouldShow(a.actionContext,{menu:a}))return;f=b.action.isEnabled&&b.action.isEnabled(a.actionContext)}e={label:e,id:b.id,disabled:!f,onClick:dojo.hitch(this,"_runAction",
b,a.actionContext)};b.iconClass&&(e.iconClass=b.iconClass);a.addChild(new I(e))}},this))},this);return a},_toggleButton:function(a,b,d,n){a.checked&&(d.forEach(function(b){b!=a&&b.set("checked",!1)}),c._runAction(a.item,b,a.item.id))},_runAction:function(a,b,d){b&&k.currentEditor&&(b=k.currentEditor);if(a.run)a.run();else if(a.action)dojo.isString(a.action)&&this._loadActionClass(a),a.action.run(b);else if(a.method&&b&&b[a.method]instanceof Function)b[a.method](d);else a.commandID&&k.executeCommand(a.commandID)},
showView:function(a,b,d){var n=new F;try{var e=dijit.byId("mainBody"),f=k.getExtension("davinci.view",a),g=dojo.byId("mainBody"),l=k.getExtension("davinci.perspective",c.activePerspective),m="left",q;dojo.some(l.views,function(b){if(b.viewID==a)return m=b.position,!0});g.tabs=g.tabs||{};g.tabs.perspective=g.tabs.perspective||{};"right"==m&&!g.tabs.perspective.right&&(e.addChild(g.tabs.perspective.right=new y({"class":"davinciPaletteContainer",style:"width: 71px;",id:"right_mainBody",minSize:71,region:"right",
gutters:!1,splitter:!0})),g.tabs.perspective.right.startup(),t.right_mainBody={expandToSize:340,initialExpandToSize:340});"left"==m&&!g.tabs.perspective.left&&(e.addChild(g.tabs.perspective.left=new y({"class":"davinciPaletteContainer",style:"width: 71px;",id:"left_mainBody",minSize:71,region:"left",gutters:!1,splitter:!0})),g.tabs.perspective.left.startup(),t.left_mainBody={expandToSize:318,initialExpandToSize:318});if("left"===m||"right"===m)m+="-top";l=m;if(g.tabs.perspective[m])q=g.tabs.perspective[m];
else{var l=m.split("-"),h=l[0],p="davinciPalette ",s="";l[1]&&("left"==h||"right"==h)?(e=g.tabs.perspective[h],h=l[1],"top"==l[1]?(h="center",p+="davinciTopPalette"):(s="height:30%;",p+="davinciBottomPalette")):"bottom"==h&&(s="height:80px;",p+="davinciBottomPalette");q=g.tabs.perspective[m]=new K({region:h,id:"palette-tabcontainer-"+m,tabPosition:l[0]+"-h",tabStrip:!1,"class":p,style:s,splitter:"center"!=h,controllerWidget:"dijit.layout.TabController"});e.addChild(q);dojo.connect(q,"selectChild",
this,function(a){if(a&&a.domNode){var b=a.getParent();!this._showViewAddChildInProcess&&!b._maqDontExpandCollapse&&(b._maqLastSelectedChild==a?this._expandCollapsePaletteContainer(a):this.expandPaletteContainer(a.domNode));b._maqLastSelectedChild=a}}.bind(this))}if(dojo.some(q.getChildren(),function(a){return a.id==f.id}))return;this.instantiateView(f).then(function(a){this._showViewAddChildInProcess=!0;d||q.addChild(a);this._showViewAddChildInProcess=!1;var c=a.controlButton;c&&c.domNode&&(c.domNode.title=
f.title+" "+P.palette);b&&q.selectChild(a);n.resolve(a)}.bind(this))}catch(G){console.error("Error loading view: "+f.id),console.error(G)}return n},instantiateView:function(a){var b=new F,d=dijit.byId(a.id);d?b.resolve(d):C([a.viewClass],function(d){var e={title:a.title,id:a.id,closable:!1,view:a};a.iconClass&&(e.iconClass=a.iconClass);c.palettes||(c.palettes={});b.resolve((c.palettes[a.viewClass]=new (d||T)(e),c.palettes[a.viewClass]))});return b},hideView:function(a){for(var b in mainBody.tabs.perspective){if("left"==
b||"right"==b)b+="-top";if(mainBody.tabs.perspective[b])for(var d=mainBody.tabs.perspective[b].getChildren(),c=0;c<d.length;c++)d[c].id==a&&(mainBody.tabs.perspective[b].removeChild(d[c]),d[c].destroyRecursive(!1))}},toggleView:function(a){dojo.byId(a)?c.hideView(a):c.showView(a,!0)},openEditor:function(a,b){try{var d=a.fileName,n;"string"==typeof d?n=d.substr(d.lastIndexOf(".")+1):(n=d.getExtension(),d=d.getPath());var e=dijit.byId(z(d)),f=dijit.byId("editors_container");if(e){f.selectChild(e);var g=
e.editor;a.startOffset&&g.select(a)}else{var l=a.editorCreateCallback,m=k.getExtensions("davinci.editor",function(a){"string"==typeof a.extensions&&(a.extensions=a.extensions.split(","));return dojo.some(a.extensions,function(a){return a.toLowerCase()==n.toLowerCase()})}),q=m[0];1<m.length&&dojo.some(m,function(a){q=a;return a.isDefault});c._createEditor(q,d,a,b).then(function(b){l&&l.call(window,b);a.noSelect||(k.currentEditor=b)},function(a){console.error("Error opening editor for filename: "+d,
a)})}}catch(h){console.error("Exception opening editor for filename: "+a&&a.fileName),console.error(h)}},_createEditor:function(a,b,d,n){var e=new F,f=b.split("/").pop(),g=d&&d.fileName&&d.fileName.extension?"."+d.fileName.extension:"",f=f+(".rev"==g?g:"");dojo.query(".loading").orphan();var g=dijit.byId("editorsStackContainer"),l=dijit.byId("editors_container");g&&l&&(g.selectChild(l),c.mainStackContainer.selectChild(c.mainBorderContainer));var m=dijit.byId(z(b)),g=dijit.byId("editors_container"),
l=dijit.byId("davinci_file_tabs"),k=!1,h=null;if(!m){var k=!0,h=z(b),p=w(h),m=new U({title:f,id:h,"class":"EditorContainer",isDirty:d.isDirty}),h=new E({title:f,closable:!0,id:p});h.onClose=function(a,b){function d(){g._skipDirtyCheck=!0;g.onClose.apply(g,[n,g]);a.removeChild(b);b.destroyRecursive()}function e(){g.editor.save();d()}var f=L(b.id),g=dijit.byId(f),n=dijit.byId("editors_container");n&&g&&(g.editor.isDirty?((f=g.editor.getOnUnloadWarningMessage())||(f=dojo.string.substitute(v.fileHasUnsavedChanges,
[g._getTitle()])),c.showDialog({title:g._getTitle(),content:f,style:{width:300},okLabel:Q.save,okCallback:dojo.hitch(this,e),hideLabel:null,submitOnEnter:!0,extendLabels:[Q.discard],extendCallbacks:[dojo.hitch(this,d)]})):d())}}a||(a={editorClass:"davinci/ui/TextEditor",id:"davinci.ui.TextEditor"});k&&(g.addChild(m),l.addChild(h));if(!c.hideEditorTabs){var s=dojo.query(".dijitTabButtonIcon",m.controlButton.domNode);dojo.addClass(s[0],"tabButtonLoadingIcon");dojo.removeClass(s[0],"dijitNoIcon")}d.noSelect||
g.selectChild(m);d.initializationTime||(c._state.activeEditor=b);m.setEditor(a,b,!0,d.fileName,m.domNode,n).then(function(a){d.startLine&&m.editor.select(d);d.noSelect||(-1===c._state.editors.indexOf(b)&&c._state.editors.push(b),c._switchEditor(m.editor,d.startup));c.hideEditorTabs||(dojo.removeClass(s[0],"tabButtonLoadingIcon"),dojo.addClass(s[0],"dijitNoIcon"));setTimeout(function(){m.resize()},100);e.resolve(m.editor)},function(a){c.hideEditorTabs||(dojo.removeClass(s[0],"tabButtonLoadingIcon"),
dojo.addClass(s[0],"tabButtonErrorIcon"));e.reject(a)});return e},createPopup:function(a){var b=a.partID,d=a.domNode,n=a.context,e=a.openCallback,f=this.getActionSets(b),g=f.clonedActionSets,f=f.actionSets;if(0<g.length)return g=c._createMenuTree(g,!0),c._initActionsKeys(f,a),(a=c._createMenu(g,n))&&d&&a.bindDomNode(d),a._widgetCallback=e,a._partID=b,a},getActionSets:function(a){var b=[];k.getExtension("davinci.actionSetPartAssociations",function(d){return d.parts.some(function(c){if(c==a)return b.push(d.targetID),
!0})});var d,c=[];b.length&&(d=k.getExtensions("davinci.actionSets",function(a){return b.some(function(b){return b==a.id})}),d.length&&d.forEach(function(a){var b=N.getLibraryActions(a.id);b.length&&(a=S.mixin({},a),a.actions=a.actions.concat(b));c.push(a)}));return{actionSets:d,clonedActionSets:c}},_initActionsKeys:function(a,b){var d=b.keysDomNode||b.domNode,n={},e;dojo.forEach(a,function(a){dojo.forEach(a.actions,function(a){a.keySequence&&(n[a.keySequence]=a,e=!0)})});if(e){var f=b.context;dojo.connect(d,
"onkeydown",function(a){a=c._keySequence(a);(a=n[a])&&(!a.action.shouldShow||a.action.shouldShow(f))&&a.action.isEnabled(f)&&c._runAction(a,f)})}},_initKeys:function(){var a={all:[]},b=k.getExtensions("davinci.keyBindings");dojo.forEach(b,function(b){var c=b.contextID||"all",e=a[c];e||(e=a[c]=[]);e[b.sequence]=b.commandID});c.keyBindings=a},handleKey:function(a){if(c.keyBindings){a=c._keySequence(a);var b;c.currentContext&&c.keyBindings[c.currentContext]&&(b=c.keyBindings[c.currentContext][a]);b||
(b=c.keyBindings.all[a]);if(b)return k.executeCommand(b),!0}},_keySequence:function(a){var b=[];window.event?(window.event.ctrlKey&&b.push("M1"),window.event.shiftKey&&b.push("M2"),window.event.altKey&&b.push("M3")):((a.ctrlKey||2==a.modifiers||3==a.modifiers||5<a.modifiers)&&b.push("M1"),(a.shiftKey||3<a.modifiers)&&b.push("M2"),a.modifiers?(a.altKey||a.modifiers%2)&&b.push("M3"):a.altKey&&b.push("M3"));var d=String.fromCharCode(a.keyCode);/[A-Z0-9]/.test(d)||(d={46:"del",114:"f3"}[a.keyCode]||"xxxxxxxxxx");
d=d.toUpperCase();" "==d&&(d="' '");b.push(d);return b.join("+")},setActionScope:function(a,b){c.actionScope[a]=b},findView:function(a){if(a=dijit.byId(a))return a},_switchEditor:function(a,b){var d=k.currentEditor;k.currentEditor=a;c._state.activeEditor=a?a.fileName:null;this._removeFocusContainerChildren();this._showEditorTopPanes();try{dojo.publish("/davinci/ui/editorSelected",[{editor:a,oldEditor:d}])}catch(n){console.error(n)}c._updateTitle(a);setTimeout(function(){a&&(a.visualEditor&&a.visualEditor.context&&
a.visualEditor.context.isActive())&&a.visualEditor.context.getTopWidgets().forEach(function(a){a.resize&&a.resize()});this._repositionFocusContainer()}.bind(this),1E3);da(this._showViewPromises).then(function(){a&&a.focus&&a.focus();this._rearrangePalettes(a);this._expandCollapsePaletteContainers(a)}.bind(this));b||(c.saveState=!0)},_rearrangePalettes:function(a){var b,d,c;if(a){if((d=k.getExtensions("davinci.editor",function(b){return a?b.id===a.editorID:!1}))&&0<d.length){var e=d[0];b=e.palettePerspective}d=
a._rightPaletteExpanded;c=a._leftPaletteExpanded}else b=k.initialPerspective||"davinci.ui.main";b&&((b=k.getExtension("davinci.perspective",b))||k.handleError(dojo.string.substitute(v.perspectiveNotFound,[e.palettePerspective])),dojo.forEach(b.views,function(a){var b=a.viewID,d=a.position;0>d.indexOf("bottom")&&(d+="-top");if(b=dijit.byId(b)){var c=b.getParent(),d=mainBody.tabs.perspective[d];c!=d&&(c&&c.removeChild(b),a.hidden||(d.addChild(b),c=d));c&&(a.hidden?c.removeChild(b):a.selected&&(c._maqDontExpandCollapse=
!0,c.selectChild(b),delete c._maqDontExpandCollapse))}}));a&&(a.hasOwnProperty("_rightPaletteExpanded")&&(a._rightPaletteExpanded=d),a.hasOwnProperty("_leftPaletteExpanded")&&(a._leftPaletteExpanded=c))},_nearlyCollapsed:function(a){a=dojo.style(a,"width");"string"==typeof a&&(a=parseInt(a));return 91>a},_expandCollapsePaletteContainer:function(a){if(a&&a.domNode&&(a=davinci.Workbench.findPaletteContainerNode(a.domNode),a.id)){var b=a._maqExpanded,d;this._nearlyCollapsed(a)&&(b=!1,d=91<=t[a.id].expandToSize?
t[a.id].expandToSize:t[a.id].initialExpandToSize);b?this.collapsePaletteContainer(a):this.expandPaletteContainer(a,{expandToSize:d})}},_expandCollapsePaletteContainers:function(a,b){var d=dijit.byId("left_mainBody"),c=dijit.byId("right_mainBody");if(a){var e=k.getExtensions("davinci.editor",function(b){return b.id===a.editorID});if(e&&0<e.length){var e=e[0].expandPalettes,f;d&&((f=a&&a.hasOwnProperty("_leftPaletteExpanded")?a._leftPaletteExpanded:e&&0<=e.indexOf("left"))?this.expandPaletteContainer(d.domNode,
b):this.collapsePaletteContainer(d.domNode,b));c&&((f=a&&a.hasOwnProperty("_rightPaletteExpanded")?a._rightPaletteExpanded:e&&0<=e.indexOf("right"))?this.expandPaletteContainer(c.domNode,b):this.collapsePaletteContainer(c.domNode,b))}}else d&&this.collapsePaletteContainer(d.domNode,b),c&&this.collapsePaletteContainer(c.domNode,b)},_updateTitle:function(a){var b=c._baseTitle;a&&(b+=" - ",a.isDirty&&(b+="*"),b+=a.fileName);dojo.doc.title=b},_editorTabClosed:function(a){if(!davinci.Workbench._editorTabClosing[a.id]){davinci.Workbench._editorTabClosing[a.id]=
!0;if(a&&a.editor&&a.editor.fileName){var b=w(a.id),d=dijit.byId("davinci_file_tabs"),n=dijit.byId(b),e=c._state.editors.indexOf(a.editor.fileName);-1!=e&&c._state.editors.splice(e,1);c.saveState=!0;davinci.Workbench._shadowTabClosing[b]||(d.removeChild(n),n.destroyRecursive())}dijit.byId("editors_container").getChildren().length||(c._switchEditor(null),this._expandCollapsePaletteContainers(null),b=dijit.byId("editorsStackContainer"),d=dijit.byId("editorsWelcomePage"),b&&d&&b.selectChild(d),this._hideEditorTopPanes());
delete davinci.Workbench._editorTabClosing[a.id]}},_shadowTabClosed:function(a){if(!davinci.Workbench._shadowTabClosing[a.id]){davinci.Workbench._shadowTabClosing[a.id]=!0;var b=L(a.id);if(!davinci.Workbench._editorTabClosing[b]){var b=dijit.byId(b),d=dijit.byId("editors_container");d&&b&&(d.removeChild(b),b.destroyRecursive())}delete davinci.Workbench._shadowTabClosing[a.id]}},getActiveProject:function(){c._state||(c._state=k.getWorkbenchState());var a=dojo.queryToObject(dojo.doc.location.search.substr("?"===
dojo.doc.location.search[0]?1:0)).project;a&&c.loadProject(a);return c._state.hasOwnProperty("project")?c._state.project:c._DEFAULT_PROJECT},setActiveProject:function(a){c._state||(c._state={});c._state.project=a;c.saveState=!0},workbenchStateCustomPropGet:function(a){if("string"==typeof a)return c._state[a]},workbenchStateCustomPropSet:function(a,b){"string"==typeof a&&("undefined"==typeof b?delete c._state[a]:c._state[a]=b,c.saveState=!0)},clearWorkbenchState:function(){c._state={};return c.updateWorkbenchState()},
updateWorkbenchState:function(){delete c.saveState;return this.service.serviceObject[this.serviceClass].setState(JSON.stringify(c._state))},_autoSave:function(){function a(a){if(!a.isReadOnly&&a.isDirty){var c=a.lastModifiedTime;if(c&&c>b)try{a.save(!0)}catch(f){console.error("Error while autosaving file:"+f),d=!0}}}var b=c._lastAutoSave,d=!1;c.editorTabs&&dojo.forEach(c.editorTabs.getChildren(),a);d||(c._lastAutoSave=Date.now())},setupGlobalKeyboardHandler:function(){var a=k.getExtensions("davinci.actionSets");
dojo.forEach(a,function(a){("davinci.ui.main"==a.id||"davinci.ui.editorActions"==a.id)&&dojo.forEach(a.actions,function(a){a.keyBinding&&k.registerKeyBinding(a.keyBinding,a)})})},findPaletteContainerNode:function(a){for(var b;a&&"BODY"!=a.tagName;){if(dojo.hasClass(a,"davinciPaletteContainer")){b=a;break}a=a.parentNode}return b},collapsePaletteContainer:function(a,b){var d=davinci.Workbench.findPaletteContainerNode(a);if(d&&d.id){var c=d.id,e=dojo.style(d,"width"),f=dijit.byNode(d),g=dojo.query("[role\x3dtablist]",
d);if(f&&0<g.length){var g=dojo.marginBox(g[0]),l=f.getParent();if(l&&l.resize&&g&&g.w){if(!this._nearlyCollapsed(d)&&(!b||!b.dontPreserveWidth))t[c].expandToSize=e;d.style.width=g.w+"px";l.resize();f._isCollapsed=!0}}dojo.removeClass(d,"maqPaletteExpanded");d._maqExpanded=!1;davinci.Workbench._repositionFocusContainer();if(c=k.currentEditor)"left_mainBody"==d.id?c._leftPaletteExpanded=!1:"right_mainBody"==d.id&&(c._rightPaletteExpanded=!1)}},expandPaletteContainer:function(a,b){var d=b&&b.expandToSize,
c=davinci.Workbench.findPaletteContainerNode(a);if(c&&c.id){var e=c.id,f=dijit.byNode(c);d&&(t[e].expandToSize=d);if(f&&t[e].expandToSize&&(d=f.getParent())&&d.resize)c.style.width=t[e].expandToSize+"px",d.resize(),delete f._isCollapsed;dojo.addClass(c,"maqPaletteExpanded");c._maqExpanded=!0;davinci.Workbench._repositionFocusContainer();if(e=k.currentEditor)"left_mainBody"==c.id?e._leftPaletteExpanded=!0:"right_mainBody"==c.id&&(e._rightPaletteExpanded=!0)}},_repositionFocusContainer:function(){var a=
dojo.byId("editors_container"),b=dojo.byId("focusContainer");if(a&&b){var d=k.currentEditor;if(a=d&&d.getFocusContainerBounds?d.getFocusContainerBounds():ha.getBorderBoxPageCoords(a))b.style.left=a.l+"px",b.style.top=a.t+"px",b.style.width=a.w+"px",b.style.height=a.h+"px",d&&d.getContext&&(b=d.getContext())&&b.updateFocusAll&&b.updateFocusAll()}},_hideShowEditorTopPanes:function(a){var b=dijit.byId("davinci_app"),d=dijit.byId("davinci_file_tabs"),c=dijit.byId("davinci_toolbar_pane");d.domNode.style.display=
a;c.domNode.style.display=a;b.resize()},_hideEditorTopPanes:function(){this._hideShowEditorTopPanes("none")},_showEditorTopPanes:function(){this._hideShowEditorTopPanes("block")},_removeFocusContainerChildren:function(){davinci.Workbench.focusContainer.innerHTML=""},_XX_last_member:!0},na=ea(H,{menuOpened:function(a){},_openMyself:function(a){this.menuOpened(a);var b;try{var c=document.getElementById("menuOverlayDiv");c||(c=dojo.create("div",{id:"menuOverlayDiv",style:"left:0px; top:0px; width:100%; height:100%; position:absolute; z-index:10;"},
document.body));if(this.adjustPosition){var k=this.adjustPosition(a);b=dijit.popup.open;dijit.popup.open=function(a){a.x+=k.x;a.y+=k.y;b.call(dijit.popup,a)}}this.onClose=function(){var a=document.getElementById("menuOverlayDiv");a&&a.parentNode.removeChild(a)}.bind(this);this.inherited(arguments)}finally{b&&(dijit.popup.open=b)}}});window.setInterval(function(){c.saveState&&c.updateWorkbenchState()},5E3);dojo.setObject("davinci.Workbench",c);return c});
//# sourceMappingURL=_WorkbenchImpl.js.map