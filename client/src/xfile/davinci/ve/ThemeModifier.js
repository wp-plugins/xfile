//>>built
define("davinci/ve/ThemeModifier","dojo/_base/declare ../model/Path ../model/Factory ./utils/URLRewrite ./commands/ModifyRuleCommand ./commands/StyleCommand dojo/i18n!davinci/ve/nls/common system/resource".split(" "),function(l,k,m,f,n,p,q,r){return l("davinci.ve.ThemeModifier",null,{_getCssFiles:function(){if(this.cssFiles)return this.cssFiles;this.cssFiles=[];if(this.themeCssFiles){var a=this._themePath.getParentPath();this.cssFiles=this.themeCssFiles.map(function(b){return m.getModel({url:a.append(b).toString(),
includeImports:!0})})}return this.cssFiles},_getThemeResource:function(a){a=this._themePath.getParentPath().append(a).toString();return system.resource.findResource(a)},getDeltaRule:function(a){var b=null,c=this.cssFiles[0],e=a.getSelectorText();this.cssFiles.forEach(function(a){var d=a.getRules(e);0<d.length&&(c=a);d.forEach(function(c){c.parent.url==a.url&&(b=c)}.bind(this))}.bind(this));!b&&c&&(b=c.addRule(e+" {}"));return b},_markDirty:function(a,b){this._dirtyResource||(this._dirtyResource={});
this._dirtyResource[a]={time:Date.now(),modelObject:b};this._srcChanged()},getCommandForStyleChange:function(a){var b=this.getSelection(),c=b.length?b[b.length-1]:void 0;1<b.length&&this.select(c);if("inline"==a.appliesTo){for(var e=[],s=new k(this.fileName),b=0;b<a.values.length;b++)for(var d in a.values[b]){if(f.containsUrl(a.values[b][d])&&!f.isAbsolute(a.values[b][d])){var g=new k(f.getUrl(a.values[b][d]));if(g.isAbsolute){var h={};h[d]=a.values[b][d]}else g=g.relativeTo(s).toString(),f.replaceUrl(a.values[b][d],
g)}else h={},h[d]=a.values[b][d];e.push(h)}a=new p(c,e,a.applyToWhichStates)}else{if("proposal"==a.appliesTo.type){c=this.model.find({elementType:"CSSFile",relativeURL:a.appliesTo.targetFile},!0);if(!c&&this.cssFiles){for(b=0;this.cssFiles.length;b++)if(this.cssFiles[b].url===a.appliesTo.targetFile){c=this.cssFiles[b];break}if(!c)return}c=c.addRule(a.appliesTo.ruleString+" {}")}else c=a.appliesTo.rule;a=new n(c,a.values,this)}return a},saveDynamicCssFiles:function(a,b){var c=[],e={visit:function(a){"CSSFile"==
a.elementType&&a.isDirty()&&c.push(a.save(b).then(function(c){b||r.findResource(a.url).removeWorkingCopy();a.dirtyResource=b;return a},function(b){console.error(dojo.string.substitute(q.errorSavingFile,[a.url,b]));return b}));return!1}};a&&a.forEach(function(a){a.visit(e)});return c},dirtyDynamicCssFiles:function(a){if(null==a)return console.error("dirtyDynamicCssFiles:invalid arg"),!1;var b=!1,c={visit:function(a){"CSSFile"==a.elementType&&a.isDirty()&&(b=!0);return b}};a&&a.forEach(function(a){if(b)return b;
a.visit(c)});return b},close:function(){this.cssFiles&&this.cssFiles.forEach(function(a){a.close();require("davinci/model/Factory").closeModel(a)}.bind(this));delete this.cssFiles},destroy:function(){this.close()}})});
//# sourceMappingURL=ThemeModifier.js.map